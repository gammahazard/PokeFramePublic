const y={MAP_ID:54110,MAP_BANK:54111,MAP_TILESET:54118,MAP_EVENTS_FLAG:54367,WARP_ENABLED:54507,PLAYER_X:54114,PLAYER_Y:54113,PLAYER_FACING:54432,PLAYER_STATE:54567,GAME_MODE:53335,OVERWORLD_MODE:53541,MAP_SCRIPT_PTR:55091,TILEMAP_UPDATE:65347,VRAM_FLAG:65344,SCY_REGISTER:65346,VRAM_TRANSFER_FLAG:65466,VRAM_TRANSFER_SECTION:65467,VRAM_DEST_ADDR_L:65468,VRAM_DEST_ADDR_H:65469,VRAM_SRC_ADDR_L:65473,VRAM_SRC_ADDR_H:65474},e={UP:3,DOWN:0,LEFT:1,RIGHT:2,A:4,B:5,START:6,SELECT:7};function p(o,_,t){if(!o)return!1;const c=i=>{t&&typeof t=="function"&&t(Math.min(100,Math.max(0,i)))},n=i=>{if(_&&typeof _=="function")_(i);else for(let s=0;s<i;s++)try{o.run_frame()}catch(A){console.warn("Frame execution error:",A)}};try{if(console.log("Applying enhanced Pokémon map rendering fix..."),c(5),typeof o.read_byte=="function"&&typeof o.write_byte=="function"){console.log("Applying direct VRAM register manipulation...");try{const i=o.read_byte(y.VRAM_FLAG),s=o.read_byte(y.TILEMAP_UPDATE),A=o.read_byte(y.SCY_REGISTER);o.read_byte(y.VRAM_TRANSFER_FLAG)!==0&&(o.write_byte(y.VRAM_TRANSFER_FLAG,0),console.log("Reset pending VRAM transfer flag")),o.write_byte(y.TILEMAP_UPDATE,(s+1)%256),n(2),o.write_byte(y.TILEMAP_UPDATE,s),o.write_byte(y.SCY_REGISTER,(A+1)%256),n(2),o.write_byte(y.SCY_REGISTER,A);const l=o.read_byte(y.MAP_EVENTS_FLAG);o.write_byte(y.MAP_EVENTS_FLAG,l|1),console.log("Basic VRAM register manipulation complete"),c(20)}catch(i){console.warn("VRAM register manipulation error:",i)}}console.log("Targeting critical menu items for display rendering...");try{console.log("Menu cycle: Third item (BADGE) - most critical for rendering"),c(25),o.on_key_down(e.START),n(10),o.on_key_up(e.START),n(20),c(30);for(let i=0;i<2;i++)o.on_key_down(e.DOWN),n(8),o.on_key_up(e.DOWN),n(8);c(40),o.on_key_down(e.A),n(10),o.on_key_up(e.A),n(180),o.on_key_down(e.B),n(10),o.on_key_up(e.B),n(30),o.on_key_down(e.B),n(10),o.on_key_up(e.B),n(30),console.log("Menu cycle: Fourth item (possibly BADGE if third was SAVE)"),o.on_key_down(e.START),n(8),o.on_key_up(e.START),n(15);for(let i=0;i<3;i++)o.on_key_down(e.DOWN),n(5),o.on_key_up(e.DOWN),n(5);c(80),o.on_key_down(e.A),n(10),o.on_key_up(e.A),n(180),o.on_key_down(e.B),n(10),o.on_key_up(e.B),n(30),o.on_key_down(e.B),n(10),o.on_key_up(e.B),n(30),console.log("Critical menu items navigation complete"),c(85)}catch(i){console.warn("Menu simulation error:",i)}console.log("Simulating movement to refresh map tiles...");try{for(const i of[e.UP,e.DOWN])o.on_key_down(i),n(1),o.on_key_up(i),n(3);console.log("Movement simulation complete"),c(90)}catch(i){console.warn("Movement simulation error:",i)}return console.log("Running final stabilization frames..."),n(10),c(100),console.log("Enhanced Pokémon map fix completed"),!0}catch(i){return console.error("Error applying enhanced Pokémon map fix:",i),!1}}function E(o,_,t){if(!o)return!1;const c=n=>{t&&typeof t=="function"&&t(Math.min(100,Math.max(0,n)))};try{console.log("Applying all available Pokémon map fixes in sequence..."),c(5);try{d(o,_,n=>{c(5+n*.45)})}catch(n){console.warn("Error in black screen fix:",n)}return _(5),c(55),p(o,_,n=>{c(55+n*.4)}),_(5),c(100),console.log("All map fixes applied successfully"),!0}catch(n){return console.error("Error applying all map fixes:",n),!1}}function d(o,_,t){if(!o)return!1;const c=n=>{t&&typeof t=="function"&&t(Math.min(100,Math.max(0,n)))};try{if(console.log("Applying specialized black screen fix..."),c(5),window.pokemonMapFix&&window.pokemonMapFix.fixBlackScreenAfterLoad,typeof o.write_byte=="function"&&typeof o.read_byte=="function")try{const n=o.read_byte(y.VRAM_FLAG);o.write_byte(y.VRAM_FLAG,n&127),_(5),o.write_byte(y.VRAM_FLAG,n|128),_(5),console.log("Applied LCD control toggle to force VRAM refresh"),c(20)}catch(n){console.warn("LCD control manipulation failed:",n)}console.log("Targeting critical menu items for display rendering..."),console.log("Menu cycle: Third item (BADGE) - most critical for rendering"),o.on_key_down(e.START),_(10),o.on_key_up(e.START),_(20),c(30);for(let n=0;n<2;n++)o.on_key_down(e.DOWN),_(8),o.on_key_up(e.DOWN),_(8);o.on_key_down(e.A),_(10),o.on_key_up(e.A),_(180),o.on_key_down(e.B),_(10),o.on_key_up(e.B),_(30),o.on_key_down(e.B),_(10),o.on_key_up(e.B),_(30),c(70),console.log("Menu cycle: Fourth item (possibly BADGE if third was SAVE)"),o.on_key_down(e.START),_(8),o.on_key_up(e.START),_(15);for(let n=0;n<3;n++)o.on_key_down(e.DOWN),_(5),o.on_key_up(e.DOWN),_(5);o.on_key_down(e.A),_(10),o.on_key_up(e.A),_(180),o.on_key_down(e.B),_(10),o.on_key_up(e.B),_(30),o.on_key_down(e.B),_(10),o.on_key_up(e.B),_(30),c(85);for(const n of[e.UP,e.DOWN])o.on_key_down(n),_(1),o.on_key_up(n),_(2);return _(10),c(100),console.log("Black screen fix sequence completed"),!0}catch(n){return console.error("Error in black screen fix:",n),!1}}function k(o){if(!o||typeof o.read_byte!="function")return!1;try{const _=[4096,4176,14336];let t=0;for(const c of _)try{const n=o.read_byte(c);(n===83||n===72||n===73||n===78)&&t++}catch{}if(t>=2)return!0;try{const n=[];for(let i=0;i<8;i++)n.push(o.read_byte(5376+i));if(n[0]===205&&n[3]===250&&n[7]===33)return!0}catch{}}catch(_){console.warn("Error in Shin Pokémon detection:",_)}return!1}window.enhancedPokemonMapFix={applyAllMapFixes:E,enhancedMapFix:p,fixBlackScreen:d,detectShinPokemon:k};export{E as applyAllMapFixes,k as detectShinPokemon,p as enhancedMapFix,d as fixBlackScreen};
