const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/gb_web-ZP2ourm1.js","assets/gb_web_bg-DGoeA2lS.js","assets/__vite-plugin-wasm-helper-D7K_KhUE.js","assets/index-BBtjCGTq.js","assets/index-ByT9wwdi.css","assets/SaveStateHelpers-DHZewPwJ.js"])))=>i.map(i=>d[i]);
import{r as p,_ as Z,j as l,R as et,s as oe,c as Gt,g as Vt,m as Ht,e as dt,u as ft,f as $t,h as qt,l as tt}from"./index-BBtjCGTq.js";import{r as Be}from"./romsList-BhNhH5pS.js";const Jt=({onWasmLoaded:e,onError:t})=>{const n=p.useRef(!1);return p.useEffect(()=>{if(n.current)return;n.current=!0;async function r(){try{console.log("Loading WASM modules...");const o=await Z(()=>import("./gb_web-ZP2ourm1.js"),__vite__mapDeps([0,1,2])),c=(await Z(()=>import("./gb_web_bg-DGoeA2lS.js").then(i=>i.w),__vite__mapDeps([1,2]))).memory;if(!c)throw new Error("Could not access WASM memory");const a={UP:o.JsKeys?.ArrowUp||38,DOWN:o.JsKeys?.ArrowDown||40,LEFT:o.JsKeys?.ArrowLeft||37,RIGHT:o.JsKeys?.ArrowRight||39,A:o.JsKeys?.A||90,B:o.JsKeys?.B||88,START:o.JsKeys?.Start||13,SELECT:o.JsKeys?.Select||16};typeof window<"u"&&(window.memory=c),console.log("WASM modules loaded successfully"),e(o,c,a)}catch(o){console.error("Error loading WASM modules:",o),t(`Error loading emulator: ${o}`)}}r()},[e,t]),null};let ot=!1,nt=0;const Xt=5;function Zt(e){try{const t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),n=/iPhone|iPad|iPod/i.test(navigator.userAgent);if(console.log(`Audio context state before warmup (${t?"mobile":"desktop"})`,e.state),ot){e.state==="suspended"&&(console.log("Audio context is suspended, attempting to resume it"),e.resume().catch(s=>{console.warn("Audio context resume failed:",s)}));return}if(ot=!0,e.state==="suspended"&&(console.log("Resuming suspended audio context"),e.resume().then(()=>{console.log("Audio context resumed successfully:",e.state),n&&xe(e)}).catch(s=>{console.warn("Audio context resume failed:",s),n&&xe(e)})),t)n?xe(e):(console.log("Playing silent buffer to activate audio system on mobile"),Qt(e));else{console.log("Playing silent buffer to activate audio system on desktop");const s=e.createBuffer(2,2048,e.sampleRate),c=e.createBufferSource();c.buffer=s,c.connect(e.destination),c.start(0)}const r=()=>{if(nt++,e.state!=="running"){e.resume().catch(()=>{});try{if(n)xe(e);else{const s=e.createBuffer(2,1024,e.sampleRate),c=e.createBufferSource();c.buffer=s,c.connect(e.destination),c.start(0),console.log("Played silent buffer for wakeup")}}catch(s){console.warn("Failed to play wakeup buffer:",s)}}if(nt>=Xt&&e.state!=="running"){console.log("Trying last resort oscillator approach for audio unlock");try{const s=e.createOscillator(),c=e.createGain();c.gain.value=.01,s.type="sine",s.frequency.value=440,s.connect(c),c.connect(e.destination),s.start(e.currentTime),s.stop(e.currentTime+.05)}catch(s){console.warn("Oscillator unlock attempt failed:",s)}}};console.log("Adding audio wakeup event listeners"),document.addEventListener("visibilitychange",r),document.addEventListener("touchstart",r,{once:!1}),document.addEventListener("touchend",r,{once:!1}),document.addEventListener("click",r,{once:!1}),document.addEventListener("keydown",r,{once:!1}),setTimeout(()=>{document.querySelectorAll("button").forEach(c=>{c.addEventListener("click",r,{once:!1}),c.addEventListener("touchstart",r,{once:!1})})},500),console.log("Audio system initialization complete, state:",e.state);const o=s=>{setTimeout(()=>{console.log(`Audio state check after ${s}ms:`,e.state),e.state!=="running"&&(console.warn(`Audio context still not running after ${s}ms`),r())},s)};o(500),o(1e3),o(2e3),o(5e3)}catch(t){console.error("Failed to initialize audio:",t)}}function xe(e){try{console.log("Playing iOS-specific unlock buffer");const t=e.createBuffer(2,1,44100),n=t.getChannelData(0);n[0]=.1;const r=e.createBufferSource();r.buffer=t,r.connect(e.destination),r.start(0),setTimeout(()=>{e.resume().catch(()=>{})},100)}catch(t){console.warn("iOS unlock buffer failed:",t)}}function Qt(e){try{const t=e.createBuffer(2,1024,e.sampleRate),n=t.getChannelData(0);for(let o=0;o<n.length;o++)n[o]=1e-5*(Math.random()*2-1);const r=e.createBufferSource();r.buffer=t,r.connect(e.destination),r.start(0),console.log("Mobile silent buffer played successfully")}catch(t){console.warn("Error playing mobile silent buffer:",t)}}const Kt=4096,H=2;let fe=[];const Q=/iPhone|iPad|iPod/i.test(navigator.userAgent),Yt=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),eo=/Android/i.test(navigator.userAgent),pt=Q||eo,U=navigator.userAgent.includes("Warpcast")||navigator.userAgent.includes("WebView");function K(){fe.forEach(e=>{e.state!=="running"&&typeof e.resume=="function"&&e.resume().then(()=>{if(Q||Yt)try{const t=e.createOscillator(),n=e.createGain();n.gain.value=.3,t.frequency.value=440,t.type="sine",t.connect(n),n.connect(e.destination),t.start(e.currentTime),t.stop(e.currentTime+.3),setTimeout(()=>{try{const r=e.createBuffer(2,4410,44100),o=r.getChannelData(0),s=r.getChannelData(1);for(let a=0;a<o.length;a++){const i=.25*Math.sin(2*Math.PI*440*a/44100);o[a]=i,s[a]=i}const c=e.createBufferSource();c.buffer=r,c.connect(e.destination),c.start(0)}catch{}},50)}catch(t){console.warn("iOS sound unlock error (non-critical):",t);try{const n=e.createBuffer(1,1,44100);n.getChannelData(0)[0]=.5;const r=e.createBufferSource();r.buffer=n,r.connect(e.destination),r.start(0)}catch{}}}).catch(()=>{})}),fe=fe.filter(e=>e.state!=="running")}function to(){const e=["touchstart","touchend","click","keydown"],t=()=>{K()};e.forEach(n=>{document.addEventListener(n,t,{passive:!0})}),Q&&setTimeout(()=>{try{document.querySelectorAll("button").forEach(r=>{r.addEventListener("touchstart",t,{passive:!0}),r.addEventListener("click",t,{passive:!0})})}catch{}},1e3)}to();function gt(e){if(e.state!=="running"&&fe.push(e),Zt(e),pt){console.log("Mobile device detected, using optimized audio settings");let s=!1;try{s=localStorage.getItem("isWarpcastEnvironment")==="true"}catch{}U&&s?console.log("Warpcast environment detected - waiting for direct interaction"):we(e)}const t=e.createGain();let n=U;try{n=U||localStorage.getItem("isWarpcastEnvironment")==="true"}catch{}t.gain.value=n?1:.8;const r=e.createBiquadFilter();r.type="lowpass",r.frequency.value=n?6e3:5e3,r.Q.value=.3;const o=e.createBiquadFilter();return o.type="lowpass",o.frequency.value=n?8e3:6500,o.Q.value=.5,r.connect(o),o.connect(t),t.connect(e.destination),{gainNode:t,lowPassFilter:r,secondLowPass:o,setVolume:s=>{const c=e.currentTime;t.gain.cancelScheduledValues(c),t.gain.setValueAtTime(t.gain.value,c),t.gain.linearRampToValueAtTime(Math.max(0,Math.min(1,s)),c+.05)},scheduleBuffer:s=>{try{e.state!=="running"&&(e.resume().catch(()=>{}),Q&&K());const c=e.createBufferSource();if(c.buffer=s,Q){const a=e.createGain();a.gain.value=1,c.connect(a),a.connect(r)}else c.connect(r);return c.start(0),c}catch{const a=e.createBufferSource();return e.state!=="running"&&we(e),a}},disconnect:()=>{t.disconnect(),r.disconnect(),o.disconnect()}}}function rt(e,t,n){try{if(!e||e<=0||!t?.buffer)return null;n.state!=="running"&&n.resume().catch(()=>{});const r=Kt;if(e+r*4>t.buffer.byteLength)return console.warn("Audio buffer pointer out of bounds",{bufferPtr:e,bufferSize:r*4,memorySize:t.buffer.byteLength}),null;try{const o=new Float32Array(t.buffer,e,r);let s=!1,c=!0,a=0;const i=Math.min(100,o.length);for(let v=0;v<i;v++){const S=o[v];if(isNaN(S)||!isFinite(S)){c=!1;break}const b=Math.abs(S);a=Math.max(a,b),b>.005&&(s=!0)}if(!c)return null;let u=U;try{u=U||localStorage.getItem("isWarpcastEnvironment")==="true"}catch{}if(!s&&!Q&&!(U||u))return null;const f=o.length/H,d=n.createBuffer(H,f,n.sampleRate);return U?so(o,d,f,a):Q?oo(o,d,f,a):pt?no(o,d,f):ro(o,d,f),d}catch(o){return console.warn("Error processing audio data:",o),null}}catch(r){return console.error("Error processing audio buffer:",r),null}}function oo(e,t,n,r){const o=r<.1?1.5:1;for(let s=0;s<H;s++){const c=t.getChannelData(s);let a=0;const i=.4;for(let u=0;u<n;u++){const f=u*H+s;if(f<e.length){let d=e[f];(isNaN(d)||!isFinite(d))&&(d=0),d=d*(1-i)+a*i,a=d,d*=o,d=Math.max(-.95,Math.min(.95,d)),Math.abs(d)<.001&&u%50===0&&(d+=.001*(Math.random()*2-1)),c[u]=d}else c[u]=0}}}function no(e,t,n){for(let r=0;r<H;r++){const o=t.getChannelData(r);let s=0;const c=.5;for(let a=0;a<n;a++){const i=a*H+r;if(i<e.length){let u=e[i];(isNaN(u)||!isFinite(u))&&(u=0),u=u*(1-c)+s*c,s=u,u=Math.max(-.8,Math.min(.8,u)),o[a]=u}else o[a]=0}}}function ro(e,t,n){for(let r=0;r<H;r++){const o=t.getChannelData(r);let s=0;const c=.35;for(let a=0;a<n;a++){const i=a*H+r;if(i<e.length){let u=e[i];(isNaN(u)||!isFinite(u))&&(u=0),u=u*(1-c)+s*c,s=u,u=Math.max(-.9,Math.min(.9,u)),o[a]=u}else o[a]=0}}}function so(e,t,n,r){const o=r<.05?3:r<.1?2:r<.2?1.5:1.2;for(let s=0;s<H;s++){const c=t.getChannelData(s);let a=0;const i=.25;for(let u=0;u<n;u++){const f=u*H+s;if(f<e.length){let d=e[f];(isNaN(d)||!isFinite(d))&&(d=0),d=d*(1-i)+a*i,a=d,d*=o,Math.abs(d)<.01&&(d+=.005*(Math.random()*2-1)),d>.85?d=.85+Math.tanh((d-.85)*2)*.15:d<-.85&&(d=-.85-Math.tanh((-d-.85)*2)*.15),c[u]=d}else c[u]=.001*(Math.random()*2-1)}}}function we(e,t){e.state!=="running"&&fe.push(e),typeof e.resume=="function"?e.resume().then(()=>{let n=U;try{n=U||localStorage.getItem("isWarpcastEnvironment")==="true"}catch{}if(Q||U||n)try{const r=e.createOscillator(),o=e.createGain();o.gain.value=U?.8:.3,r.frequency.value=440,r.type="sine",r.connect(o),o.connect(e.destination),r.start(e.currentTime),r.stop(e.currentTime+(U?.5:.3)),setTimeout(()=>{try{const s=e.createOscillator(),c=e.createGain();c.gain.value=.2,s.frequency.value=880,s.connect(c),c.connect(e.destination),s.start(e.currentTime),s.stop(e.currentTime+.1)}catch{}},50)}catch{try{const o=e.createBuffer(2,4410,44100),s=o.getChannelData(0),c=o.getChannelData(1);for(let i=0;i<s.length;i++){const u=.2*Math.sin(i*.1);s[i]=u,c[i]=u}const a=e.createBufferSource();a.buffer=o,a.connect(e.destination),a.start(0)}catch{try{const o=e.createBuffer(1,1,44100);o.getChannelData(0)[0]=.5;const s=e.createBufferSource();s.buffer=o,s.connect(e.destination),s.start(0)}catch{}}}t&&t()}).catch(()=>{if(Q)try{const n=e.createBuffer(2,8820,44100),r=n.getChannelData(0),o=n.getChannelData(1);for(let c=0;c<r.length;c++){const i=440+c/r.length*440,u=.25*Math.sin(c*(i/4e3));r[c]=u,o[c]=u}const s=e.createBufferSource();s.buffer=n,s.connect(e.destination),s.start(0),setTimeout(()=>{e.resume().catch(()=>{}),t&&t()},200)}catch{t&&t()}else t&&t()}).catch(n=>{console.warn("Audio context resume failed:",n),t&&t()}):(console.warn("Audio context resume method not available"),t&&t())}function io(){const e=/iPhone|iPad|iPod/i.test(navigator.userAgent);try{if(e){const t=new(window.AudioContext||window.webkitAudioContext);return console.log("Created iOS audio context:",t.state),t}else return new AudioContext({sampleRate:44100,latencyHint:/Android/i.test(navigator.userAgent)?"playback":"interactive"})}catch(t){return console.error("Failed to create AudioContext:",t),new(window.AudioContext||window.webkitAudioContext)}}function ht(){return/iPhone|iPad|iPod/i.test(navigator.userAgent)}function mt(){return navigator.userAgent.includes("Warpcast")||navigator.userAgent.includes("WebView")||window.location.search.includes("warpcast=true")}function ao(e,t,n){const r=()=>{console.log("Received audio-initialized event from MiniAppSimplePlay"),t&&t.state!=="running"&&typeof t.resume=="function"&&t.resume().then(()=>{console.log("AudioContext resumed from global event"),e(!0)}),e(!0)},o=()=>{if(console.log("Received warpcast-audio-unmute event"),t&&t.state!=="running"&&typeof t.resume=="function"&&t.resume().then(()=>{console.log("AudioContext resumed from Warpcast unmute event")}),n.current)try{n.current.setVolume(1),console.log("Audio volume set to maximum from Warpcast event")}catch(u){console.error("Error setting volume from Warpcast event:",u)}e(!0)},s=()=>{console.log("Received audio-unlocked event"),t&&t.state!=="running"&&typeof t.resume=="function"&&t.resume().then(()=>{console.log("AudioContext resumed from audio-unlocked event")}),e(!0)},c=()=>{console.log("Received sound-enabled event"),e(!0)};window.addEventListener("audio-initialized",r),window.addEventListener("warpcast-audio-unmute",o),window.addEventListener("audio-unlocked",s),window.addEventListener("sound-enabled",c);const a=()=>{const u=localStorage.getItem("warpcastAudioEnabled"),f=localStorage.getItem("audioUnlocked"),d=localStorage.getItem("audioContextInitialized");(u==="true"||f==="true"||d==="true")&&(console.log("Found Warpcast audio indicators in localStorage"),e(!0),t&&t.state!=="running"&&typeof t.resume=="function"&&t.resume().then(()=>{console.log("AudioContext resumed from localStorage indicators")}))};a();const i=setInterval(a,1e3);return()=>{window.removeEventListener("audio-initialized",r),window.removeEventListener("warpcast-audio-unmute",o),window.removeEventListener("audio-unlocked",s),window.removeEventListener("sound-enabled",c),clearInterval(i)}}function co(e,t){if(!ht())return document.addEventListener("touchstart",t,{once:!1}),document.addEventListener("click",t,{once:!1}),()=>{document.removeEventListener("touchstart",t),document.removeEventListener("click",t)};document.addEventListener("touchstart",t,{capture:!0}),document.addEventListener("touchend",t,{capture:!0}),document.addEventListener("click",t,{capture:!0}),document.querySelectorAll("[data-sound], button, .controls, .touchControls").forEach(s=>{s.addEventListener("touchstart",t,{capture:!0}),s.addEventListener("click",t,{capture:!0})});const o=setTimeout(()=>{try{document.querySelectorAll("button").forEach(a=>{a.addEventListener("touchstart",t,{capture:!0}),a.addEventListener("click",t,{capture:!0})}),document.querySelectorAll(".touch-controls, .d-pad, .buttons").forEach(a=>{a.addEventListener("touchstart",t,{capture:!0})})}catch(s){console.warn("Error setting up additional element listeners:",s)}},500);return we(e,()=>{try{const s=e.createBuffer(1,1,44100),c=e.createBufferSource();c.buffer=s,c.connect(e.destination),c.start(0),console.log("Played initial unlock attempt")}catch(s){console.warn("Initial unlock failed:",s)}}),()=>{clearTimeout(o),document.removeEventListener("touchstart",t),document.removeEventListener("touchend",t),document.removeEventListener("click",t)}}function lo(e){if(mt()&&(console.log("Setting Warpcast environment in localStorage"),localStorage.setItem("isWarpcastEnvironment","true"),localStorage.setItem("warpcastAudioEnabled","true"),window.warpcastAudioForcedEnabled=!0,e.current))try{e.current.setVolume(1),console.log("Set maximum volume for Warpcast")}catch(n){console.error("Error setting Warpcast volume:",n)}}const uo=({emulatorRef:e,wasmModuleRef:t,audioSystemRef:n,audioContext:r,soundEnabled:o,setSoundEnabled:s,onAudioBufferCallback:c})=>{const a=p.useRef(!1);return p.useEffect(()=>{if(a.current)return;a.current=!0;const i=ao(s,r,n);return ht()&&co(r,()=>{K(),r.state!=="running"&&typeof r.resume=="function"&&r.resume().catch(()=>{})}),mt()&&lo(n),i},[]),p.useEffect(()=>{!n.current||!e.current||(K(),n.current.enabled=o,o&&r.state==="suspended"&&typeof r.resume=="function"&&r.resume().catch(()=>{}),we(n.current))},[o,n.current,e.current]),p.useEffect(()=>{e.current&&!n.current&&(n.current=gt(r))},[e.current]),null},fo=e=>{const t=o=>{switch(o){case"pokemon_yellow":return"pokemon_yellow";case"pokemon_blue":return"pokemon_blue";case"pokemon_shin_blue":return"pokemon_shin_blue";default:return"pokemon_blue"}},n=o=>{switch(o){case"pokemon_yellow":return"Pokémon Yellow";case"pokemon_blue":return"Pokémon Blue";case"pokemon_shin_blue":return"Pokémon Shin Blue";default:return"Pokémon Blue"}},r=o=>{switch(o){case"pokemon_blue":return Be.find(s=>s.name==="pokemon-blue/pokemon_blue.gb")?.url;case"pokemon_yellow":return Be.find(s=>s.name==="pokemon-yellow/yellow.gbc")?.url;default:return Be.find(s=>s.name==="pokemon-blue/pokemon_blue.gb")?.url}};return{gameName:t(e),gameTitle:n(e),romUrl:r(e)}};class yt{maxPoolSize;initialSize;uint8Buffers=new Map;float32Buffers=new Map;activeBuffers=new Map;stats={bufferCacheHits:0,bufferCacheMisses:0,totalBufferRequests:0,peakConcurrentBuffers:0,bufferReuse:0,memoryAllocated:0};constructor(t={maxPoolSize:50,initialSize:5}){this.maxPoolSize=t.maxPoolSize,this.initialSize=t.initialSize}getUint8Buffer(t){this.stats.totalBufferRequests++;const n=this.normalizeSize(t);this.uint8Buffers.has(n)||this.uint8Buffers.set(n,[]);const r=this.uint8Buffers.get(n);if(r.length>0){const s=r.pop();return this.activeBuffers.set(s,n),this.stats.bufferCacheHits++,s}this.stats.bufferCacheMisses++,this.stats.memoryAllocated+=n;const o=new Uint8Array(n);return this.activeBuffers.set(o,n),this.activeBuffers.size>this.stats.peakConcurrentBuffers&&(this.stats.peakConcurrentBuffers=this.activeBuffers.size),o}getFloat32Buffer(t){this.stats.totalBufferRequests++;const n=this.normalizeSize(t);this.float32Buffers.has(n)||this.float32Buffers.set(n,[]);const r=this.float32Buffers.get(n);if(r.length>0){const s=r.pop();return this.activeBuffers.set(s,n),this.stats.bufferCacheHits++,s}this.stats.bufferCacheMisses++,this.stats.memoryAllocated+=n*4;const o=new Float32Array(n);return this.activeBuffers.set(o,n),this.activeBuffers.size>this.stats.peakConcurrentBuffers&&(this.stats.peakConcurrentBuffers=this.activeBuffers.size),o}releaseBuffer(t){if(!this.activeBuffers.has(t)){console.warn("Attempted to release a buffer that was not allocated from the pool");return}t.fill(0);const n=this.activeBuffers.get(t);if(this.activeBuffers.delete(t),t instanceof Uint8Array){const r=this.uint8Buffers.get(n);r.length<this.maxPoolSize&&(r.push(t),this.stats.bufferReuse++)}else if(t instanceof Float32Array){const r=this.float32Buffers.get(n);r.length<this.maxPoolSize&&(r.push(t),this.stats.bufferReuse++)}}normalizeSize(t){return Math.pow(2,Math.ceil(Math.log2(t)))}prealloc(t,n){for(const r of t){const o=this.normalizeSize(r);for(let s=0;s<this.initialSize;s++)n==="uint8"?(this.uint8Buffers.has(o)||this.uint8Buffers.set(o,[]),this.uint8Buffers.get(o).push(new Uint8Array(o)),this.stats.memoryAllocated+=o):(this.float32Buffers.has(o)||this.float32Buffers.set(o,[]),this.float32Buffers.get(o).push(new Float32Array(o)),this.stats.memoryAllocated+=o*4)}}getStats(){return{...this.stats}}resetStats(){this.stats={bufferCacheHits:0,bufferCacheMisses:0,totalBufferRequests:0,peakConcurrentBuffers:0,bufferReuse:0,memoryAllocated:this.stats.memoryAllocated}}}let le=null;function bt(){return le||(le=new yt,le.prealloc([160*144*3,2048,4096,8192],"uint8"),le.prealloc([2048,4096],"float32")),le}class xt{wasmMemory=null;bufferPool;activeViews=new Map;viewCacheHits=0;constructor(t=bt()){this.bufferPool=t}setWasmMemory(t){this.wasmMemory=t,this.activeViews.clear()}getMemoryView(t,n){if(!this.wasmMemory)throw new Error("WASM memory not set");this.activeViews.has(t)||this.activeViews.set(t,new Map);const r=this.activeViews.get(t);if(r.has(n))return this.viewCacheHits++,r.get(n);const o=new Uint8Array(this.wasmMemory.buffer,t,n);return r.set(n,o),o}invalidateViewCache(){this.activeViews.clear()}copyFromWasmMemory(t,n){if(!this.wasmMemory)throw new Error("WASM memory not set");const r=this.bufferPool.getUint8Buffer(n),o=this.getMemoryView(t,n);return r.set(o),r}releaseBuffer(t){this.bufferPool.releaseBuffer(t)}getStats(){return{...this.bufferPool.getStats(),viewCacheHits:this.viewCacheHits}}}let Re=null;function wt(){return Re||(Re=new xt),Re}const po=Object.freeze(Object.defineProperty({__proto__:null,BufferPool:yt,MemoryOptimizer:xt,getBufferPool:bt,getMemoryOptimizer:wt},Symbol.toStringTag,{value:"Module"})),D=160,F=144,st=D*F*3,J=255;let Le=null,X=null,ue=0,de=null,ne=0,O=1;function go(e){if(e<1||e>5){console.warn("Scale must be between 1 and 5, got:",e);return}O=e}function vt(e,t,n=1,r=!1){try{let o;if(e instanceof CanvasRenderingContext2D?o=e:o=e.getContext("2d"),!o)return console.error("Could not get canvas context"),!1;if(n!==O&&(O=n,o.canvas.width=D*n,o.canvas.height=F*n,o.imageSmoothingEnabled=!1),!t||!o)return console.error("Missing emulator or context in renderFrame"),!1;if(o.canvas.style.display="block",o.canvas.style.visibility="visible",o.canvas.style.opacity="1",r)try{t.run_frame()}catch(u){console.error("Error running frame:",u)}let s;try{if(s=t.get_canvas_data_pointer(),!s)return console.error("Canvas data pointer is null"),!1}catch(u){return console.error("Error getting canvas data pointer:",u),!1}const c=window.memory;if(!c||!c.buffer)return console.error("WebAssembly memory not accessible"),o.fillStyle="#FF0000",o.fillRect(0,0,D*O,F*O),o.fillStyle="#FFFFFF",o.font="10px monospace",o.textAlign="center",o.fillText("MEMORY ERROR",D*O/2,F*O/2),!1;Le||(Le=o.createImageData(D,F));const a=Le,i=a.data;try{if(!X||ue!==s||de!==c.buffer)try{ne=0,X=new Uint8Array(c.buffer,s,st),ue=s,de=c.buffer;const b=X[0]+X[1]+X[2]}catch(b){throw console.error("Error creating memory view:",b),X=null,ue=0,de=null,new Error(`Unable to create memory view: ${b.message}`)}const u=X;let f=0,d=0;const v=D*F,S=Math.floor(v/8);for(let b=0;b<S;b++)i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J,i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J,i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J,i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J,i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J,i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J,i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J,i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J;for(let b=S*8;b<v;b++)i[f++]=u[d++],i[f++]=u[d++],i[f++]=u[d++],i[f++]=J;if(o.putImageData(a,0,0),O>1)try{const b=o.canvas.width,A=o.canvas.height,P=document.createElement("canvas");P.width=D,P.height=F;const T=P.getContext("2d");T&&(T.putImageData(a,0,0),o.canvas.width!==D*O||o.canvas.height!==F*O?(o.canvas.width=D*O,o.canvas.height=F*O,o.imageSmoothingEnabled=!1,"webkitImageSmoothingEnabled"in o&&(o.webkitImageSmoothingEnabled=!1),"mozImageSmoothingEnabled"in o&&(o.mozImageSmoothingEnabled=!1),"msImageSmoothingEnabled"in o&&(o.msImageSmoothingEnabled=!1)):o.clearRect(0,0,b,A),o.drawImage(P,0,0,D,F,0,0,D*O,F*O))}catch(b){console.error("Error during scaling:",b),o.putImageData(a,0,0)}return!0}catch(u){if(console.error("Error accessing WebAssembly memory:",u,{canvasDataPointer:s,memoryBufferSize:c?.buffer?.byteLength||0,retryCount:ne}),ne<3){ne++,console.log(`Memory access error, attempting recovery (retry ${ne}/3)`),X=null,ue=0,de=null;try{r&&(console.log("Running a recovery frame in the emulator"),t.run_frame());const f=t.get_canvas_data_pointer();if(ne>1&&console.log(`New canvas data pointer after recovery: ${f}`),f&&f>0)try{return X=new Uint8Array(c.buffer,f,st),ue=f,de=c.buffer,console.log("Created new memory view, attempting to render with fresh pointer"),o.fillStyle="#004400",o.fillRect(0,0,D,F),o.fillStyle="#FFFFFF",o.font="10px monospace",o.textAlign="center",o.fillText("RECOVERING DISPLAY...",D/2,F/2),!0}catch(d){console.error("Recovery attempt failed:",d)}}catch(f){console.error("Error during recovery attempt:",f)}}return o.fillStyle="#AA0000",o.fillRect(0,0,D,F),o.fillStyle="#FFFFFF",o.font="10px monospace",o.textAlign="center",o.fillText("MEMORY ACCESS ERROR",D/2,F/2-10),o.fillText("PLEASE REFRESH PAGE",D/2,F/2+10),!1}}catch(o){console.error("Unexpected error in renderFrame:",o);try{const s=e instanceof CanvasRenderingContext2D?e:e.getContext("2d");s&&(s.fillStyle="#FF0000",s.fillRect(0,0,D,F),s.fillStyle="#FFFFFF",s.font="10px monospace",s.textAlign="center",s.fillText("RENDERING ERROR",D/2,F/2))}catch{}return!1}}const ho=({wasmModule:e,memory:t,romUrl:n,canvasRef:r,audioContext:o,onAudioBufferCallback:s,scale:c,onEmulatorReady:a,onError:i,setIsLoading:u,setMapFixesApplied:f,setConfirmationModalDismissed:d})=>{const v=p.useRef(null),S=p.useRef(null),[b,A]=p.useState(!1),P=(T=!0)=>{if(!r.current||!v.current)return!1;try{return window.memory=t,vt(r.current,v.current,c,T)}catch(R){return console.error("Render error:",R),!1}};return p.useEffect(()=>{if(!e||!t||!n){console.log("WASM not ready yet:",{wasmModule:!!e,memory:!!t,romUrl:!!n});return}async function T(){console.log("Attempting to initialize emulator...");let R=r.current,x=0;const k=10;for(;!R&&x<k;)console.log(`Canvas not found, retrying... (${x+1}/${k})`),await new Promise(j=>setTimeout(j,100)),R=r.current,x++;if(!R){console.error("Canvas still not found after retries"),i("Canvas not found after retries");return}console.log("Canvas found, proceeding with initialization"),R.width=320,R.height=288;const y=R.getContext("2d");y&&(y.fillStyle="#9bbc0f",y.fillRect(0,0,320,288),y.fillStyle="#000",y.font="10px monospace",y.textAlign="center",y.fillText("LOADING GAME...",320/2,288/2),y.imageSmoothingEnabled=!1),typeof window<"u"&&(window.DISPLAY_WIDTH=D,window.DISPLAY_HEIGHT=F,window.scale=c),go(c);try{const j=await fetch(n);if(!j.ok)throw new Error(`Failed to load ROM: ${j.statusText}`);const _=new Uint8Array(await j.arrayBuffer()),G=Array.from(_.slice(0,16)).map(L=>L.toString(16).padStart(2,"0")).join(" ");console.log(`ROM header: ${G}`),f(!1),d(!1);try{const L=new e.WebCartridge(_),N=new e.WebEmulator(L,s);v.current=N;try{const C=N.is_cgb_mode();A(C),console.log("CGB mode:",C)}catch{console.log("CGB mode detection not available")}wt().setWasmMemory(t),S.current=gt(o);try{N.set_audio_buffer_callback(s),console.log("Audio callback set successfully")}catch(C){console.warn("Failed to set audio callback:",C)}console.log("Running initial frames...");for(let C=0;C<3;C++){for(let W=0;W<5;W++)N.run_frame();P(!1)}console.log("Emulator initialized successfully"),u(!1),a(N)}catch(L){console.error("Failed to initialize emulator:",L),i(`Failed to initialize emulator: ${L}`)}}catch(j){i(`Failed to load ROM: ${j}`)}}T()},[e,t,n]),{emulatorRef:v,audioSystemRef:S,isCgbMode:b,renderGameFrame:P}},mo=({emulatorRef:e,canvasRef:t,audioContext:n,scale:r,soundEnabled:o,setSoundEnabled:s,isLoading:c,inputQueueRef:a})=>{const i=p.useRef(null);p.useRef(0),p.useRef(performance.now());const u=p.useRef(!1),f=(b=!0)=>{if(!t.current||!e.current)return!1;try{const A=t.current,P=A.style.display!=="none"&&A.offsetParent!==null;window.memory&&(window.memory=window.memory),b&&e.current.run_frame();const T=vt(t.current,e.current,r,!1);return T||console.warn("🚨 Render failed - canvas visible:",P,"canvas display:",A.style.display),T}catch(A){return console.error("Recovery attempt failed:",A),!1}},d=()=>{let b=0,A=0,P=performance.now();if(t.current){const x=t.current,k=()=>{K(),s(!0),n.state==="suspended"&&typeof n.resume=="function"&&n.resume().catch(y=>{console.warn("Audio context resume failed:",y)})};x.removeEventListener("touchstart",k),x.removeEventListener("click",k),x.removeEventListener("mousedown",k),x.addEventListener("touchstart",k),x.addEventListener("click",k),x.addEventListener("mousedown",k)}const T=()=>{const x=a.current;for(;x.length>0;){const{type:k,keyCode:y}=x.shift();k==="down"?e.current?.on_key_down?.(y):e.current?.on_key_up?.(y)}},R=()=>{try{if(u.current){b=requestAnimationFrame(R);return}if(e.current&&t.current){T();const x=f(!0);A++;const k=performance.now();b=requestAnimationFrame(R)}else console.warn("Game loop condition failed:",{hasEmulator:!!e.current,hasCanvas:!!t.current}),b=requestAnimationFrame(R)}catch(x){console.error("Error in game loop:",x),b=requestAnimationFrame(R)}};return b=requestAnimationFrame(R),i.current=b,()=>{b&&(cancelAnimationFrame(b),i.current=null)}};return p.useEffect(()=>{if(e.current&&t.current&&!c)return console.log("🚀 Starting game loop"),d()},[c]),{renderGameFrame:f,startGameLoop:d,pauseGameLoop:()=>{u.current=!0},resumeGameLoop:()=>{u.current=!1}}},yo=({visible:e,keyCodes:t,onKeyDown:n,onKeyUp:r})=>{const[o,s]=p.useState({UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1,A:!1,B:!1,START:!1,SELECT:!1}),c=i=>u=>{K(),console.log(`Touch START on ${i} button, keyCode: ${t[i]}`),s(f=>({...f,[i]:!0}));try{n(t[i]),console.log(`Successfully sent ${i} keyDown event`)}catch(f){console.error(`Error sending ${i} keyDown event:`,f)}window.navigator&&window.navigator.vibrate&&window.navigator.vibrate(30)},a=i=>u=>{K(),console.log(`Touch END on ${i} button, keyCode: ${t[i]}`),s(f=>({...f,[i]:!1}));try{r(t[i]),console.log(`Successfully sent ${i} keyUp event`)}catch(f){console.error(`Error sending ${i} keyUp event:`,f)}};return e?l.jsxs(l.Fragment,{children:[l.jsx("style",{children:`
        /* Apply these styles globally to prevent iOS text selection and highlight */
        .touch-button, .touch-control {
          -webkit-touch-callout: none !important;
          -webkit-user-select: none !important;
          -khtml-user-select: none !important;
          -moz-user-select: none !important;
          -ms-user-select: none !important;
          user-select: none !important;
          -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
          touch-action: manipulation !important;
          pointer-events: auto !important;
        }
        
        /* Prevent text selection on buttons and their content */
        .touch-button {
          cursor: pointer !important;
          text-align: center !important;
          -webkit-user-drag: none !important;
          user-drag: none !important;
        }
        
        /* Ensure text inside buttons can't be selected */
        .touch-button * {
          -webkit-touch-callout: none !important;
          -webkit-user-select: none !important;
          user-select: none !important;
          pointer-events: none !important;
        }
        
        /* Specific iOS fixes for long touch */
        @media (pointer: coarse) {
          .touch-button:active {
            opacity: 0.8 !important;
          }
        }
        
        /* Animation for the touch controls */
        @keyframes slideUpIn {
          from { transform: translateY(100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
      `}),l.jsx("div",{className:"touch-control",style:{position:"fixed",bottom:0,left:0,right:0,display:"flex",flexDirection:"column",padding:"5px",backgroundColor:"rgba(58, 83, 155, 0.85)",backdropFilter:"blur(5px)",boxShadow:"0 -4px 10px rgba(0, 0, 0, 0.3)",zIndex:90,touchAction:"none",userSelect:"none",height:"28vh",maxHeight:"200px",minHeight:"140px",WebkitTouchCallout:"none",WebkitUserSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTapHighlightColor:"rgba(0,0,0,0)",animation:"slideUpIn 0.3s ease-out",borderTop:"2px solid rgba(58, 83, 155, 0.5)"},children:l.jsxs("div",{style:{display:"flex",justifyContent:"space-around",width:"100%",height:"100%",alignItems:"center",maxWidth:"500px",margin:"0 auto"},children:[l.jsxs("div",{style:{position:"relative",width:"130px",height:"130px",backgroundColor:"rgba(0, 0, 0, 0.6)",borderRadius:"50%",display:"flex",justifyContent:"center",alignItems:"center",touchAction:"none",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.4)",border:"2px solid rgba(255, 255, 255, 0.1)"},children:[l.jsx("div",{className:"touch-button",onTouchStart:c("UP"),onTouchEnd:a("UP"),onTouchCancel:a("UP"),onMouseDown:i=>{c("UP")(i)},onMouseUp:i=>{a("UP")(i)},onMouseLeave:i=>{a("UP")(i)},style:{position:"absolute",width:"48px",height:"48px",backgroundColor:o.UP?"#ffcb05":"rgba(0, 0, 0, 0.7)",border:"2px solid #3a539b",top:"3px",left:"50%",transform:"translateX(-50%)",borderRadius:"15px 15px 0 0",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"24px",fontWeight:"bold",touchAction:"none",boxShadow:o.UP?"0 0 10px rgba(255, 203, 5, 0.9)":"none",transition:"all 0.1s ease-in-out",WebkitTouchCallout:"none",WebkitUserSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTapHighlightColor:"rgba(0,0,0,0)",pointerEvents:"auto"},children:l.jsx("span",{className:"button-text",children:"▲"})}),l.jsx("div",{className:"touch-button",onTouchStart:c("DOWN"),onTouchEnd:a("DOWN"),onTouchCancel:a("DOWN"),onMouseDown:i=>{c("DOWN")(i)},onMouseUp:i=>{a("DOWN")(i)},onMouseLeave:i=>{a("DOWN")(i)},style:{position:"absolute",width:"48px",height:"48px",backgroundColor:o.DOWN?"#ffcb05":"rgba(0, 0, 0, 0.7)",border:"2px solid #3a539b",bottom:"3px",left:"50%",transform:"translateX(-50%)",borderRadius:"0 0 15px 15px",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"24px",fontWeight:"bold",touchAction:"none",boxShadow:o.DOWN?"0 0 10px rgba(255, 203, 5, 0.9)":"none",transition:"all 0.1s ease-in-out",WebkitTouchCallout:"none",WebkitUserSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTapHighlightColor:"rgba(0,0,0,0)",pointerEvents:"auto"},children:l.jsx("span",{className:"button-text",children:"▼"})}),l.jsx("div",{className:"touch-button",onTouchStart:c("LEFT"),onTouchEnd:a("LEFT"),onTouchCancel:a("LEFT"),onMouseDown:i=>{c("LEFT")(i)},onMouseUp:i=>{a("LEFT")(i)},onMouseLeave:i=>{a("LEFT")(i)},style:{position:"absolute",width:"48px",height:"48px",backgroundColor:o.LEFT?"#ffcb05":"rgba(0, 0, 0, 0.7)",border:"2px solid #3a539b",left:"3px",top:"50%",transform:"translateY(-50%)",borderRadius:"15px 0 0 15px",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"24px",fontWeight:"bold",touchAction:"none",boxShadow:o.LEFT?"0 0 10px rgba(255, 203, 5, 0.9)":"none",transition:"all 0.1s ease-in-out",WebkitTouchCallout:"none",WebkitUserSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTapHighlightColor:"rgba(0,0,0,0)",pointerEvents:"auto"},children:l.jsx("span",{className:"button-text",children:"◀"})}),l.jsx("div",{className:"touch-button",onTouchStart:c("RIGHT"),onTouchEnd:a("RIGHT"),onTouchCancel:a("RIGHT"),onMouseDown:i=>{c("RIGHT")(i)},onMouseUp:i=>{a("RIGHT")(i)},onMouseLeave:i=>{a("RIGHT")(i)},style:{position:"absolute",width:"48px",height:"48px",backgroundColor:o.RIGHT?"#ffcb05":"rgba(0, 0, 0, 0.7)",border:"2px solid #3a539b",right:"3px",top:"50%",transform:"translateY(-50%)",borderRadius:"0 15px 15px 0",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"24px",fontWeight:"bold",touchAction:"none",boxShadow:o.RIGHT?"0 0 10px rgba(255, 203, 5, 0.9)":"none",transition:"all 0.1s ease-in-out",WebkitTouchCallout:"none",WebkitUserSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",WebkitTapHighlightColor:"rgba(0,0,0,0)",pointerEvents:"auto"},children:l.jsx("span",{className:"button-text",children:"▶"})})]}),l.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"20px",marginRight:"10px",position:"relative",height:"100%",justifyContent:"center"},children:[l.jsxs("div",{style:{display:"flex",gap:"25px",transform:"rotate(-15deg)"},children:[l.jsx("div",{className:"touch-button",onTouchStart:c("B"),onTouchEnd:a("B"),onTouchCancel:a("B"),onMouseDown:i=>{c("B")(i)},onMouseUp:i=>{a("B")(i)},onMouseLeave:i=>{a("B")(i)},style:{width:"60px",height:"60px",backgroundColor:o.B?"#ffcb05":"rgba(0, 0, 0, 0.6)",border:"3px solid #3a539b",borderRadius:"50%",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"22px",fontWeight:"bold",boxShadow:o.B?"0 0 10px rgba(255, 203, 5, 0.9), 0 4px 8px rgba(0, 0, 0, 0.4)":"0 4px 8px rgba(0, 0, 0, 0.4)",touchAction:"none",transition:"all 0.1s ease-in-out"},children:l.jsx("span",{className:"button-text",children:"B"})}),l.jsx("div",{className:"touch-button",onTouchStart:c("A"),onTouchEnd:a("A"),onTouchCancel:a("A"),onMouseDown:i=>{c("A")(i)},onMouseUp:i=>{a("A")(i)},onMouseLeave:i=>{a("A")(i)},style:{width:"60px",height:"60px",backgroundColor:o.A?"#ffcb05":"rgba(0, 0, 0, 0.6)",border:"3px solid #3a539b",borderRadius:"50%",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"22px",fontWeight:"bold",boxShadow:o.A?"0 0 10px rgba(255, 203, 5, 0.9), 0 4px 8px rgba(0, 0, 0, 0.4)":"0 4px 8px rgba(0, 0, 0, 0.4)",touchAction:"none",transition:"all 0.1s ease-in-out"},children:l.jsx("span",{className:"button-text",children:"A"})})]}),l.jsxs("div",{style:{display:"flex",gap:"20px",marginTop:"20px",transform:"rotate(-15deg)"},children:[l.jsx("div",{className:"touch-button",onTouchStart:c("SELECT"),onTouchEnd:a("SELECT"),onTouchCancel:a("SELECT"),onMouseDown:i=>{c("SELECT")(i)},onMouseUp:i=>{a("SELECT")(i)},onMouseLeave:i=>{a("SELECT")(i)},style:{width:"70px",height:"30px",backgroundColor:o.SELECT?"#ffcb05":"rgba(0, 0, 0, 0.6)",border:"2px solid #3a539b",borderRadius:"10px",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"14px",fontWeight:"bold",boxShadow:o.SELECT?"0 0 10px rgba(255, 203, 5, 0.9), 0 4px 8px rgba(0, 0, 0, 0.4)":"0 4px 8px rgba(0, 0, 0, 0.4)",touchAction:"none",transition:"all 0.1s ease-in-out"},children:l.jsx("span",{className:"button-text",children:"SELECT"})}),l.jsx("div",{className:"touch-button",onTouchStart:c("START"),onTouchEnd:a("START"),onTouchCancel:a("START"),onMouseDown:i=>{c("START")(i)},onMouseUp:i=>{a("START")(i)},onMouseLeave:i=>{a("START")(i)},style:{width:"70px",height:"30px",backgroundColor:o.START?"#ffcb05":"rgba(0, 0, 0, 0.6)",border:"2px solid #3a539b",borderRadius:"10px",display:"flex",justifyContent:"center",alignItems:"center",color:"white",fontSize:"14px",fontWeight:"bold",boxShadow:o.START?"0 0 10px rgba(255, 203, 5, 0.9), 0 4px 8px rgba(0, 0, 0, 0.4)":"0 4px 8px rgba(0, 0, 0, 0.4)",touchAction:"none",transition:"all 0.1s ease-in-out"},children:l.jsx("span",{className:"button-text",children:"START"})})]})]})]})})]}):null};function it(){let e=!1;try{e=localStorage.getItem("forceShowTouchControls")==="true"}catch(a){console.warn("Could not access localStorage for touch controls settings:",a)}if(e)return console.log("Touch controls forced by mini app environment"),!0;const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),n=window.innerWidth<=900,r="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,o=window.innerHeight>window.innerWidth,s=window.location.href.includes("warpcast.com")||window.location.hostname.includes("farcaster.xyz")||window.location.search.includes("miniapp=true"),c=t||n&&r||o&&r||s;return console.log("Mobile detection:",{userAgentMobile:t,smallScreen:n,hasTouch:r,isPortrait:o,isFarcasterApp:s,forceShowTouchControls:e,windowWidth:window.innerWidth,windowHeight:window.innerHeight,result:c}),c}const bo=({onSave:e,onLoad:t,hasSaveState:n,disabled:r=!1,savingState:o="idle",loadingState:s="idle",lastSaved:c=null})=>{const[a,i]=p.useState(""),[u,f]=p.useState(!1),[d,v]=p.useState("success"),S=p.useRef(null),b=p.useRef(null),A=p.useRef(0);p.useEffect(()=>{console.log("savingState changed:",o),o==="success"?P("Game saved successfully!","success"):o==="error"&&P("Failed to save game","error")},[o]),p.useEffect(()=>()=>{S.current!==null&&window.clearTimeout(S.current),b.current!==null&&window.clearTimeout(b.current)},[]),p.useEffect(()=>{console.log("loadingState changed:",s),s==="success"?P("Game loaded successfully!","success"):s==="error"&&P("Failed to load game","error")},[s]);const P=(x,k="success")=>{console.log(`Showing notification: "${x}" (${k})`),i(x),v(k),f(!0),setTimeout(()=>{console.log(`Hiding notification: "${x}"`),f(!1)},3e3)},T=x=>{switch(x){case"saving":case"loading":return"#ffdb5c";case"success":return"#4CAF50";case"error":return"#f44336";default:return"#ffcb05"}},R=()=>{if(typeof window>"u")return!1;const x=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),k=window.innerWidth<=900,y="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,j=window.innerHeight>window.innerWidth;return x||k&&y||j&&y};return l.jsxs("div",{style:{position:"relative",display:"flex",flexDirection:"column",alignItems:"center",margin:"0",width:"auto"},children:[u&&l.jsx("div",{style:{position:"fixed",top:"70px",left:"50%",transform:"translateX(-50%)",backgroundColor:d==="success"?"rgba(39, 174, 96, 0.9)":"rgba(192, 57, 43, 0.9)",color:"white",padding:"8px 12px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.4)",whiteSpace:"nowrap",zIndex:1e3,fontSize:"0.9rem",animation:"fadeIn 0.3s ease forwards",backdropFilter:"blur(5px)",maxWidth:"90%",textAlign:"center",pointerEvents:"none"},children:a}),l.jsxs("div",{style:{display:"flex",flexDirection:"row",gap:"10px",justifyContent:"center",alignItems:"center",position:"relative",zIndex:100},children:[l.jsxs("button",{onClick:x=>{x.preventDefault(),x.stopPropagation();const k=Date.now();if(k-A.current<1e3){console.log("Save button clicked too soon, debouncing...");return}if(A.current=k,S.current!==null&&(window.clearTimeout(S.current),S.current=null),typeof e=="function")try{e().then(y=>{y&&(S.current=window.setTimeout(()=>{S.current=null},500))}).catch(y=>{console.error("onSave promise rejected with error:",y)})}catch(y){console.error("Error calling onSave:",y)}},disabled:r||o==="saving",style:{backgroundColor:T(o),color:o==="success"||o==="error"?"white":"#3a539b",fontWeight:"bold",border:"none",padding:"5px 10px",borderRadius:"6px",cursor:r||o==="saving"?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:r||o==="saving"?.7:1,boxShadow:o==="saving"?"0 0 8px rgba(255, 219, 92, 0.6)":o==="success"?"0 0 10px rgba(76, 175, 80, 0.6)":o==="error"?"0 0 10px rgba(244, 67, 54, 0.6)":"0 2px 5px rgba(0, 0, 0, 0.3)",animation:o==="saving"?"pulse 1s infinite ease-in-out":"none",fontSize:"0.8rem",touchAction:"manipulation",height:"30px",display:"flex",alignItems:"center",justifyContent:"center",minWidth:"70px"},children:[o==="saving"&&l.jsx("span",{style:{display:"inline-block",width:"14px",height:"14px",marginRight:"6px",borderRadius:"50%",background:"linear-gradient(180deg, #ff1744 0%, #d50000 48%, #000 48%, #000 52%, #fafafa 52%, #e0e0e0 100%)",position:"relative",animation:"pokeball-spin 1s linear infinite",verticalAlign:"middle"},children:l.jsx("span",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"4px",height:"4px",background:"#fafafa",borderRadius:"50%",border:"1px solid #000"}})}),o==="saving"?"Saving...":"Save"]}),l.jsxs("button",{onClick:x=>{x.preventDefault(),x.stopPropagation();const k=Date.now();if(!(k-A.current<1e3)&&(A.current=k,b.current!==null&&(window.clearTimeout(b.current),b.current=null),typeof t=="function"))try{t().then(y=>{y&&(b.current=window.setTimeout(()=>{b.current=null},1e3))}).catch(y=>{console.error("onLoad promise rejected with error:",y)})}catch(y){console.error("Error calling onLoad:",y)}},disabled:r||s==="loading"||!n,style:{backgroundColor:T(s),color:s==="success"||s==="error"?"white":"#3a539b",fontWeight:"bold",border:"none",padding:"6px 12px",borderRadius:"6px",cursor:r||s==="loading"||!n?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:r||s==="loading"||!n?.7:1,boxShadow:s==="loading"?"0 0 8px rgba(255, 219, 92, 0.6)":s==="success"?"0 0 10px rgba(76, 175, 80, 0.6)":s==="error"?"0 0 10px rgba(244, 67, 54, 0.6)":"0 2px 5px rgba(0, 0, 0, 0.3)",animation:s==="loading"?"pulse 1s infinite ease-in-out":"none",fontSize:"0.9rem",touchAction:"manipulation",height:"32px",display:"flex",alignItems:"center",justifyContent:"center",minWidth:"80px"},children:[s==="loading"&&l.jsx("span",{style:{display:"inline-block",width:"14px",height:"14px",marginRight:"6px",borderRadius:"50%",background:"linear-gradient(180deg, #ff1744 0%, #d50000 48%, #000 48%, #000 52%, #fafafa 52%, #e0e0e0 100%)",position:"relative",animation:"pokeball-spin 1s linear infinite",verticalAlign:"middle"},children:l.jsx("span",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"4px",height:"4px",background:"#fafafa",borderRadius:"50%",border:"1px solid #000"}})}),s==="loading"?"Loading...":"Load"]})]}),c&&l.jsxs("div",{style:{fontSize:"0.7rem",color:"rgba(255, 255, 255, 0.8)",marginTop:"4px",textAlign:"center",textShadow:"0 1px 2px rgba(0,0,0,0.8)"},children:["Last saved: ",c.toLocaleTimeString()]}),l.jsx("style",{children:`
        @keyframes fadeIn {
          from { opacity: 0; top: ${R()?"-45px":"-35px"}; }
          to { opacity: 1; top: ${R()?"-55px":"-45px"}; }
        }
        
        @keyframes pulse {
          0% { transform: scale(1); box-shadow: 0 0 8px rgba(255, 219, 92, 0.6); }
          50% { transform: scale(${R()?"1.08":"1.05"}); box-shadow: 0 0 12px rgba(255, 219, 92, 0.8); }
          100% { transform: scale(1); box-shadow: 0 0 8px rgba(255, 219, 92, 0.6); }
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        @keyframes pokeball-spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `})]})},xo=({children:e,title:t="Debug Menu"})=>{const[n,r]=p.useState(!1),o=()=>{r(!n)};return l.jsxs(l.Fragment,{children:[l.jsxs("button",{onClick:o,"aria-label":n?"Close menu":"Open menu",style:{position:"fixed",top:"10px",right:"10px",width:"40px",height:"40px",borderRadius:"50%",background:"rgba(0, 0, 0, 0.7)",border:"2px solid #3a539b",zIndex:1e3,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",padding:"0",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.4)",cursor:"pointer",transition:"all 0.3s ease",transform:n?"rotate(90deg)":"rotate(0)"},children:[l.jsx("span",{style:{width:"20px",height:"2px",backgroundColor:n?"#ffcb05":"white",margin:"2px 0",transition:"all 0.3s ease",transform:n?"translateY(4px) rotate(45deg)":"none"}}),l.jsx("span",{style:{width:"20px",height:"2px",backgroundColor:n?"#ffcb05":"white",margin:"2px 0",transition:"all 0.3s ease",opacity:n?0:1}}),l.jsx("span",{style:{width:"20px",height:"2px",backgroundColor:n?"#ffcb05":"white",margin:"2px 0",transition:"all 0.3s ease",transform:n?"translateY(-4px) rotate(-45deg)":"none"}})]}),n&&l.jsx("div",{onClick:()=>r(!1),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:998}}),l.jsxs("div",{style:{position:"fixed",top:0,left:0,width:"250px",height:"100%",backgroundColor:"rgba(10, 20, 50, 0.95)",boxShadow:"2px 0 10px rgba(0, 0, 0, 0.5)",zIndex:999,transform:n?"translateX(0)":"translateX(-100%)",transition:"transform 0.3s ease",display:"flex",flexDirection:"column",padding:"60px 15px 20px",overflow:"auto",backdropFilter:"blur(5px)",borderRight:"1px solid rgba(255, 255, 255, 0.1)"},children:[l.jsx("h2",{style:{color:"#ffcb05",fontSize:"1.2rem",marginBottom:"20px",borderBottom:"1px solid rgba(255, 255, 255, 0.2)",paddingBottom:"10px",textAlign:"center"},children:t}),l.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:e})]})]})},wo=({emulatorRef:e,showBattleWarning:t,setShowBattleWarning:n,battleWarningShown:r,setBattleWarningShown:o})=>(p.useEffect(()=>{if(!e.current||r)return;const c=setInterval(()=>{try{if(e.current){const a=e.current.get_pc();!r&&a>0&&setTimeout(()=>{n(!0),o(!0)},5e3)}}catch{}},2e3);return()=>clearInterval(c)},[e.current,r]),t?l.jsxs("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4,backdropFilter:"blur(3px)"},children:[l.jsxs("div",{style:{background:"linear-gradient(135deg, #ff1744 0%, #d50000 100%)",border:"3px solid #ffcb05",borderRadius:"12px",padding:"20px",maxWidth:"350px",width:"90%",textAlign:"center",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.6)",animation:"slideInFromTop 0.5s ease-out"},children:[l.jsx("div",{style:{fontSize:"20px",marginBottom:"8px"},children:"🚫⚔️🚫"}),l.jsx("div",{style:{fontSize:"16px",fontWeight:"bold",color:"white",marginBottom:"8px",textShadow:"2px 2px 0px rgba(0, 0, 0, 0.7)"},children:"IMPORTANT REMINDER"}),l.jsxs("div",{style:{fontSize:"13px",color:"white",lineHeight:"1.3",textShadow:"1px 1px 0px rgba(0, 0, 0, 0.7)",marginBottom:"16px"},children:[l.jsx("strong",{children:"DO NOT SAVE DURING:"}),l.jsx("br",{}),"• Battles and dialogue (when START menu unavailable)",l.jsx("br",{}),"• Beginning dialogue (name selection)",l.jsx("br",{}),"• Indoors (can be buggy)",l.jsx("br",{}),l.jsx("strong",{children:"ONLY SAVE ONCE YOU ARE IN GAME!"}),l.jsx("br",{}),l.jsx("em",{style:{fontSize:"12px",opacity:.9},children:"Best to save outdoors when possible"}),l.jsx("br",{}),l.jsx("br",{}),l.jsxs("div",{style:{fontSize:"12px",backgroundColor:"rgba(255, 255, 255, 0.1)",padding:"8px",borderRadius:"4px",border:"1px solid rgba(255, 203, 5, 0.3)"},children:["⚠️ ",l.jsx("strong",{children:"Simple rule:"})," If you cannot access the START menu and you save the game, your save has a chance to be corrupted."]})]}),l.jsx("button",{onClick:()=>n(!1),style:{background:"#ffcb05",color:"#3a539b",border:"none",borderRadius:"8px",padding:"12px 24px",fontSize:"14px",fontWeight:"bold",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.3)"},onMouseEnter:s=>{s.currentTarget.style.transform="scale(1.05)",s.currentTarget.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)"},onMouseLeave:s=>{s.currentTarget.style.transform="scale(1)",s.currentTarget.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.3)"},children:"I UNDERSTAND - START PLAYING"})]}),l.jsx("style",{children:`
        @keyframes slideInFromTop {
          from { transform: translateY(-100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
      `})]}):null),at=({visible:e,progress:t=0,message:n="PokeFrame is optimizing your experience...",detailedStatus:r=""})=>e?l.jsxs("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:9999,backdropFilter:"blur(3px)"},children:[l.jsxs("div",{style:{backgroundColor:"#1c295d",borderRadius:"10px",padding:"20px",width:"80%",maxWidth:"300px",boxShadow:"0 0 20px rgba(0, 0, 0, 0.6)",textAlign:"center",color:"white"},children:[l.jsx("div",{style:{width:"50px",height:"50px",margin:"0 auto 20px auto",borderRadius:"50%",background:"linear-gradient(180deg, #ff1744 0%, #d50000 48%, #000 48%, #000 52%, #fafafa 52%, #e0e0e0 100%)",position:"relative",animation:"pokeball-spin 1.5s linear infinite",boxShadow:"0 0 0 3px #000, 0 2px 10px rgba(0, 0, 0, 0.3)"},children:l.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"12px",height:"12px",background:"#fafafa",border:"3px solid #000",borderRadius:"50%",zIndex:2},children:l.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"6px",height:"6px",background:"#000",borderRadius:"50%"}})})}),l.jsx("div",{style:{marginBottom:"15px",fontSize:"16px",fontWeight:"bold"},children:n}),l.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"rgba(255, 255, 255, 0.2)",borderRadius:"4px",overflow:"hidden",marginBottom:"10px"},children:l.jsx("div",{style:{width:`${t}%`,height:"100%",backgroundColor:"#ffcb05",borderRadius:"4px",transition:"width 0.2s cubic-bezier(0.4, 0, 0.2, 1)",willChange:"width"}})}),l.jsxs("div",{style:{fontSize:"12px",opacity:.8},children:[t,"% complete"]}),r&&l.jsx("div",{style:{marginTop:"15px",fontSize:"11px",lineHeight:"1.3",backgroundColor:"rgba(0, 0, 0, 0.2)",padding:"8px",borderRadius:"4px",textAlign:"left",maxHeight:"60px",overflowY:"auto",whiteSpace:"pre-line"},children:r})]}),l.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          @keyframes pokeball-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `})]}):null,vo=({visible:e,title:t,message:n,onConfirm:r,confirmText:o="OK"})=>{const[s,c]=et.useState(!1);return et.useEffect(()=>{if(e){const a=setTimeout(()=>{c(!0)},100);return()=>clearTimeout(a)}else c(!1)},[e]),!e&&!s?null:l.jsxs("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:9999,backdropFilter:"blur(3px)",opacity:s?1:0,transition:"opacity 0.3s ease"},children:[l.jsxs("div",{style:{backgroundColor:"#1c295d",borderRadius:"10px",padding:"20px",width:"85%",maxWidth:"320px",boxShadow:"0 0 20px rgba(0, 0, 0, 0.6)",textAlign:"center",color:"white",animation:"modalFadeIn 0.3s ease"},children:[l.jsx("div",{style:{fontSize:"18px",fontWeight:"bold",marginBottom:"15px",color:"#ffcb05"},children:t}),l.jsxs("div",{style:{fontSize:"14px",lineHeight:"1.4",marginBottom:"25px",textAlign:"left",padding:"0 5px"},children:[l.jsx("div",{style:{marginBottom:"15px"},children:n}),l.jsxs("div",{style:{backgroundColor:"rgba(255, 203, 5, 0.1)",border:"1px solid #ffcb05",borderRadius:"6px",padding:"10px",marginBottom:"15px"},children:[l.jsx("div",{style:{fontWeight:"bold",color:"#ffcb05",marginBottom:"5px",fontSize:"13px"},children:"📺 If you see a black screen:"}),l.jsx("div",{style:{fontSize:"12px",color:"#e0e0e0"},children:'Click the menu in top right and click "Fix Map Display"'})]}),l.jsxs("div",{style:{backgroundColor:"rgba(255, 68, 68, 0.1)",border:"1px solid #ff4444",borderRadius:"6px",padding:"10px"},children:[l.jsx("div",{style:{fontWeight:"bold",color:"#ff6b6b",marginBottom:"8px",fontSize:"13px"},children:"⚠️ CRITICAL: Save Corruption Prevention"}),l.jsxs("div",{style:{fontSize:"12px",color:"#e0e0e0",lineHeight:"1.3"},children:[l.jsx("strong",{style:{color:"#ff9999"},children:"DO NOT SAVE DURING:"}),l.jsxs("ul",{style:{margin:"5px 0",paddingLeft:"15px"},children:[l.jsx("li",{children:"• Battles (when START menu unavailable)"}),l.jsx("li",{children:"• Beginning dialogue / name selection"}),l.jsx("li",{children:"• Any dialogue or cutscenes"}),l.jsx("li",{children:"• Before starting a new game"})]}),l.jsxs("div",{style:{marginTop:"8px",fontStyle:"italic",color:"#ffcb05",fontSize:"11px"},children:[l.jsx("strong",{children:"Safe rule:"})," Only save when you can access the START menu outdoors"]})]})]})]}),l.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",marginBottom:"20px"},children:[l.jsxs("div",{style:{display:"inline-block",width:"40px",height:"40px",border:"2px solid #ffcb05",borderRadius:"50%",position:"relative",margin:"0 10px"},children:[l.jsx("div",{style:{position:"absolute",top:"5px",left:"50%",transform:"translateX(-50%)",width:"0",height:"0",borderLeft:"7px solid transparent",borderRight:"7px solid transparent",borderBottom:"7px solid #ffcb05"}}),l.jsx("div",{style:{position:"absolute",bottom:"5px",left:"50%",transform:"translateX(-50%)",width:"0",height:"0",borderLeft:"7px solid transparent",borderRight:"7px solid transparent",borderTop:"7px solid #ffcb05"}}),l.jsx("div",{style:{position:"absolute",left:"5px",top:"50%",transform:"translateY(-50%)",width:"0",height:"0",borderTop:"7px solid transparent",borderBottom:"7px solid transparent",borderRight:"7px solid #ffcb05"}}),l.jsx("div",{style:{position:"absolute",right:"5px",top:"50%",transform:"translateY(-50%)",width:"0",height:"0",borderTop:"7px solid transparent",borderBottom:"7px solid transparent",borderLeft:"7px solid #ffcb05"}})]}),l.jsxs("div",{style:{fontSize:"12px",textAlign:"center",color:"#ffcb05",fontStyle:"italic"},children:["Walk a few steps in any",l.jsx("br",{}),"direction to refresh the map",l.jsx("br",{}),l.jsx("strong",{children:"PLEASE DO NOT SAVE INDOORS"})]})]}),l.jsx("button",{onClick:r,style:{backgroundColor:"#ffcb05",color:"#1c295d",border:"2px solid #3a539b",borderRadius:"8px",padding:"12px 25px",fontSize:"16px",fontWeight:"bold",cursor:"pointer",boxShadow:"0 4px 0 #3a539b",transition:"all 0.1s ease",width:"100%",maxWidth:"200px",margin:"0 auto",position:"relative",top:"0"},onMouseDown:a=>{a.currentTarget.style.top="4px",a.currentTarget.style.boxShadow="0 0 0 #3a539b"},onMouseUp:a=>{a.currentTarget.style.top="0",a.currentTarget.style.boxShadow="0 4px 0 #3a539b"},onMouseLeave:a=>{a.currentTarget.style.top="0",a.currentTarget.style.boxShadow="0 4px 0 #3a539b"},onTouchStart:a=>{a.currentTarget.style.top="4px",a.currentTarget.style.boxShadow="0 0 0 #3a539b"},onTouchEnd:a=>{a.currentTarget.style.top="0",a.currentTarget.style.boxShadow="0 4px 0 #3a539b"},children:o})]}),l.jsx("style",{children:`
          @keyframes modalFadeIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
          }
        `})]})};async function So(e,t){try{if(!oe||!oe.actions||!oe.actions.composeCast)return console.error("Farcaster SDK is not available for sharing"),console.error("Make sure you are running in a Farcaster Mini App context"),!1;const n=t?.slice(0,2)||[];console.log("Opening Farcaster composer with the following:"),console.log(`Text: ${e}`),console.log(`Embeds: ${n.join(", ")}`);const r=await oe.actions.composeCast({text:e,embeds:n});return r?(console.log("User successfully shared content via Farcaster"),console.log("Cast data:",r),!0):(console.log("User closed the composer without sharing"),!1)}catch(n){return console.error("Error opening Farcaster composer:",n),!1}}function Ao(){return!!(oe&&oe.actions&&oe.actions.composeCast)}const Pe=256,ko=53603,To=53604;function ct(e){return e>=49152&&e<=57343?Pe+(e-49152):e<32768?Pe+e:e}const _o={153:"Bulbasaur",176:"Charmander",177:"Squirtle"};let De={};const Eo=3e5;async function Mo(e){await Gt(e)}async function Co(e){if(!e)return!1;const t=De[e],n=Date.now();if(t&&n-t.timestamp<Eo)return t.hasNotified;try{const r=await dt(e);return De[e]={hasNotified:r.hasNotified,timestamp:n},r.hasNotified}catch{return!1}}async function lt(e,t){await Ht(e,t)&&e&&(De[e]={hasNotified:!0,timestamp:Date.now()})}async function Io(e,t){if(await Co(t))return null;try{if(!e||e.length<Pe+8192)return null;const n=ct(ko),r=ct(To),o=e[n],s=e[r];if(o>0&&[153,176,177].includes(s)){const c=_o[s];return console.log(`🎉 STARTER DETECTED: ${c}`),c}return null}catch{return null}}async function ut(e,t){try{if(!Ao())return!1;const n=await Vt(),o=n[e]||0,s=u=>{const f=u%10,d=u%100;if(d>=11&&d<=13)return`${u}th`;switch(f){case 1:return`${u}st`;case 2:return`${u}nd`;case 3:return`${u}rd`;default:return`${u}th`}};let c="";e==="Bulbasaur"?c="https://img.pokemondb.net/artwork/vector/large/bulbasaur.png":e==="Charmander"?c="https://tse2.mm.bing.net/th?id=OIP.waVBWPVy3_e_iJrZZ24vNgHaH0&pid=Api&P=0&h=220":e==="Squirtle"&&(c="https://wallpapers.com/images/featured/squirtle-h6x0uzslec9uezge.jpg");const a=`I chose ${e} as my starter Pokémon in Pokémon Blue! 🎮

Check it out on PokeFrame, the Pokémon GameBoy emulator for Farcaster!

https://warpcast.com/miniapps/51wPfTDsuFku/pokeframe

I'm the ${s(o)} person to pick ${e}!

STARTER DISTRIBUTION:
🌱 Bulbasaur: ${n.Bulbasaur}
🔥 Charmander: ${n.Charmander}
💧 Squirtle: ${n.Squirtle}

#PokeFrame #PokemonBlue #GameBoy`;return await So(a,c?[c]:[])}catch{return!1}}function Bo(e,t,n){const r=document.createElement("div");r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.backgroundColor="rgba(0, 0, 0, 0.7)",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.zIndex="9999";const o=document.createElement("div");o.style.backgroundColor="#4a0072",o.style.color="white",o.style.padding="20px",o.style.borderRadius="12px",o.style.boxShadow="0 4px 20px rgba(0,0,0,0.5)",o.style.display="flex",o.style.flexDirection="column",o.style.gap="16px",o.style.maxWidth="90%",o.style.width="340px",o.style.maxHeight="90vh",o.style.transition="transform 0.3s ease",o.style.transform="scale(0.95)",o.style.animation="scaleIn 0.3s forwards";const s=document.createElement("style");s.textContent=`
    @keyframes scaleIn {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  `,document.head.appendChild(s);const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="center",c.style.marginBottom="10px";const a=document.createElement("img");e==="Bulbasaur"?a.src="https://img.pokemondb.net/artwork/vector/large/bulbasaur.png":e==="Charmander"?a.src="https://tse2.mm.bing.net/th?id=OIP.waVBWPVy3_e_iJrZZ24vNgHaH0&pid=Api&P=0&h=220":e==="Squirtle"&&(a.src="https://wallpapers.com/images/featured/squirtle-h6x0uzslec9uezge.jpg"),a.style.width="150px",a.style.height="150px",a.style.objectFit="contain",a.style.marginBottom="5px",a.onerror=()=>{a.style.display="none"},c.appendChild(a),o.appendChild(c);const i=document.createElement("div");i.textContent="Congratulations!",i.style.fontWeight="bold",i.style.fontSize="24px",i.style.textAlign="center",i.style.marginTop="5px",o.appendChild(i);const u=document.createElement("div");u.textContent=`You chose ${e} as your starter Pokémon!`,u.style.textAlign="center",u.style.fontSize="18px",u.style.lineHeight="1.4",u.style.marginBottom="10px",o.appendChild(u);const f=document.createElement("div");f.style.display="flex",f.style.justifyContent="space-between",f.style.gap="12px",f.style.marginTop="10px",o.appendChild(f);const d=document.createElement("button");d.textContent="Share on Farcaster",d.style.backgroundColor="#9000ff",d.style.color="white",d.style.border="none",d.style.padding="12px 20px",d.style.borderRadius="8px",d.style.cursor="pointer",d.style.flexGrow="1",d.style.fontWeight="bold",d.style.fontSize="16px",d.style.textTransform="uppercase",d.style.letterSpacing="0.5px",d.style.transition="background-color 0.2s",d.onmouseover=()=>{d.style.backgroundColor="#a826ff"},d.onmouseout=()=>{d.style.backgroundColor="#9000ff"},d.ontouchstart=()=>{d.style.backgroundColor="#a826ff"},d.addEventListener("click",()=>{t(),r.style.opacity="0",r.style.transition="opacity 0.3s ease",setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},300)}),f.appendChild(d);const v=document.createElement("button");v.textContent="Continue",v.style.backgroundColor="rgba(255,255,255,0.15)",v.style.color="white",v.style.border="1px solid rgba(255,255,255,0.3)",v.style.padding="12px 20px",v.style.borderRadius="8px",v.style.cursor="pointer",v.style.fontWeight="bold",v.style.fontSize="16px",v.style.transition="background-color 0.2s",v.onmouseover=()=>{v.style.backgroundColor="rgba(255,255,255,0.25)"},v.onmouseout=()=>{v.style.backgroundColor="rgba(255,255,255,0.15)"},v.ontouchstart=()=>{v.style.backgroundColor="rgba(255,255,255,0.25)"},v.addEventListener("click",()=>{n(),r.style.opacity="0",r.style.transition="opacity 0.3s ease",setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},300)}),f.appendChild(v);const S=document.createElement("div");return S.textContent="Your game will continue after you share or continue.",S.style.fontSize="14px",S.style.textAlign="center",S.style.opacity="0.8",S.style.marginTop="10px",o.appendChild(S),r.appendChild(o),setTimeout(()=>{o.style.transform="scale(1)"},50),r}function Ro({isGameReady:e,emulator:t,mapFixesApplied:n=!1,confirmationModalDismissed:r=!1,onSaveAfterDetection:o,disabled:s=!1}){const[c,a]=p.useState(null),[i,u]=p.useState(!1),[f,d]=p.useState(!1),[v,S]=p.useState(!1),b=p.useRef(null),A=p.useRef(null),P=p.useRef(null),T=p.useRef(0),{user:R}=ft(),x=R?.fid||null;return p.useEffect(()=>{t&&(P.current=t)},[t]),p.useEffect(()=>{if(!s){if(e&&!f&&x){const k=Date.now();k-T.current>5e3&&(console.log("🎮 Initializing starter detection system for userId:",x),T.current=k),u(!0),d(!0),dt(x).then(y=>{console.log("📊 Database check result:",y),y.hasNotified?(console.log(`✅ Starter already detected: ${y.starterName} - Detection DISABLED`),a(y.starterName),S(!0)):console.log("🔍 No previous starter found - Detection ENABLED"),u(!1)}).catch(y=>{console.error("Error checking starter status:",y),u(!1)})}return()=>{b.current&&b.current.parentNode&&b.current.parentNode.removeChild(b.current),A.current&&(clearInterval(A.current),A.current=null)}}},[e,f,x,s]),p.useEffect(()=>{if(s)return;if(v){const _=Date.now();_-T.current>3e4&&(console.log("🔒 Starter detection disabled - user already notified"),T.current=_);return}if(!e||i||!f){const _=Date.now();_-T.current>1e4&&(console.log("⚠️ Starter detection waiting for conditions:"),console.log(`   - isGameReady: ${e}`),console.log(`   - mapFixesApplied: ${n}`),console.log(`   - confirmationModalDismissed: ${r}`),console.log(`   - isCheckingStatus: ${i}`),console.log(`   - hasInitialized: ${f}`),T.current=_);return}if(A.current)return;console.log("🚀 Starting starter detection monitoring...");let k=0,y=0;const j=async()=>{try{const _=P.current;if(!_)return;const G=Date.now();k=G,G-T.current>1e4&&(console.log(`🔍 Scanning for starter Pokemon... (last scan: ${k})`),T.current=G);const L=_.save_state();if(!L||L.length<512)return;const N=355;let Y=0;for(let W=N;W<N+4&&W<L.length;W++)Y+=L[W]*(W-N+1);if(Y===y)return;y=Y;const C=await Io(L,x);if(G-T.current>3e4&&(console.log(`💾 Save state check: ${L?L.length+" bytes":"null"}, User: ${x}, Starter: ${C||"none"}`),T.current=G),C&&!c&&(console.log(`🎉 STARTER DETECTED: ${C} - Creating notification modal`),a(C),console.log(`📝 Marking ${C} as notified for user ${x}`),await lt(x,C),S(!0),console.log(`🚫 Starter detection disabled after finding ${C}`),!b.current||!document.body.contains(b.current))){const W=Bo(C,async()=>{console.log(`📤 User chose to share ${C}`),await ut(C,x)?console.log("✅ Successfully shared starter on Farcaster"):console.error("❌ Failed to share starter on Farcaster"),b.current=null,S(!0),A.current&&(clearInterval(A.current),A.current=null),o&&(console.log("Saving game after sharing starter"),setTimeout(()=>{o()},500))},async()=>{console.log(`❌ User dismissed ${C} notification`),await lt(x,C),b.current=null,S(!0),A.current&&(clearInterval(A.current),A.current=null),o&&(console.log("Saving game after dismissing starter notification"),setTimeout(()=>{o()},500))});console.log("📱 Adding starter notification to DOM"),document.body.appendChild(W),b.current=W,console.log("✅ Starter notification modal displayed successfully")}}catch(_){console.error("❌ Error in starter detection:",_),_ instanceof Error&&_.message?.includes("save_state")&&console.error("🔴 Emulator save state error:",_)}};return j(),A.current=window.setInterval(j,15e3),()=>{A.current&&(clearInterval(A.current),A.current=null)}},[e,n,r,f,v,s]),{detectedStarter:c,shareStarter:c?async()=>await ut(c):null,resetDetection:async()=>{await Mo(x),a(null),S(!1)},getDebugInfo:()=>({detectedStarter:c,detectionDisabled:v,hasInitialized:f,isCheckingStatus:i,userId:x,conditions:{isGameReady:e,mapFixesApplied:n,confirmationModalDismissed:r}})}}const B={MAP_ID:54110,MAP_BANK:54111,MAP_TILESET:54118,MAP_EVENTS_FLAG:54367,WARP_ENABLED:54507,PLAYER_X:54114,PLAYER_Y:54113,PLAYER_FACING:54432,PLAYER_STATE:54567,GAME_MODE:53335,OVERWORLD_MODE:53541,MAP_SCRIPT_PTR:55091,TILEMAP_UPDATE:65347,VRAM_FLAG:65344,SCY_REGISTER:65346};function Fe(e,t){if(e)try{console.log("Applying Pokemon-specific map rendering fix...");const n={UP:3,DOWN:0,LEFT:1,RIGHT:2,A:4,B:5,START:6,SELECT:7},r=[Lo,Po,Do,Fo,jo,zo];for(const o of r)try{o(e,t,n),t(15)}catch(s){console.warn(`Approach failed: ${s}`)}t(45),console.log("Map refresh complete")}catch(n){console.error("Error in Pokemon map fix:",n)}}function Lo(e,t,n){console.log("Running START menu approach for map refresh"),e.on_key_down(n.START),t(8),e.on_key_up(n.START),t(20),e.on_key_down(n.A),t(8),e.on_key_up(n.A),t(25),e.on_key_down(n.B),t(8),e.on_key_up(n.B),t(20),e.on_key_down(n.B),t(8),e.on_key_up(n.B),t(20)}function Po(e,t,n){console.log("Simulating movement in all directions for map refresh");const r=[n.UP,n.DOWN,n.LEFT,n.RIGHT];for(const o of r)e.on_key_down(o),t(8),e.on_key_up(o),t(10);e.on_key_down(n.UP),t(2),e.on_key_down(n.LEFT),t(3),e.on_key_up(n.LEFT),t(2),e.on_key_up(n.UP),t(5),e.on_key_down(n.DOWN),t(2),e.on_key_down(n.RIGHT),t(3),e.on_key_up(n.RIGHT),t(2),e.on_key_up(n.DOWN),t(5)}function Do(e,t,n){console.log("Navigating Pokemon menu for additional VRAM refresh"),e.on_key_down(n.START),t(8),e.on_key_up(n.START),t(20),e.on_key_down(n.A),t(8),e.on_key_up(n.A),t(30);for(let r=0;r<2;r++)e.on_key_down(n.B),t(8),e.on_key_up(n.B),t(20)}function Fo(e,t,n){console.log("Navigating Item menu for additional VRAM refresh"),e.on_key_down(n.START),t(5),e.on_key_up(n.START),t(15),e.on_key_down(n.DOWN),t(5),e.on_key_up(n.DOWN),t(5),e.on_key_down(n.A),t(5),e.on_key_up(n.A),t(20);for(let r=0;r<2;r++)e.on_key_down(n.B),t(5),e.on_key_up(n.B),t(15)}function jo(e,t,n){console.log("Navigating Save menu for additional VRAM refresh"),e.on_key_down(n.START),t(5),e.on_key_up(n.START),t(15);for(let r=0;r<3;r++)e.on_key_down(n.DOWN),t(3),e.on_key_up(n.DOWN),t(3);e.on_key_down(n.A),t(5),e.on_key_up(n.A),t(20),e.on_key_down(n.B),t(5),e.on_key_up(n.B),t(15),e.on_key_down(n.B),t(5),e.on_key_up(n.B),t(15)}function zo(e,t,n){console.log("Attempting direct memory manipulation for map refresh");try{if(typeof e.write_byte=="function"){e.write_byte(B.TILEMAP_UPDATE,e.read_byte(B.TILEMAP_UPDATE)+1),t(2),e.write_byte(B.TILEMAP_UPDATE,e.read_byte(B.TILEMAP_UPDATE)-1),t(2);const r=e.read_byte(B.VRAM_FLAG);if(e.write_byte(B.VRAM_FLAG,r&254),t(1),e.write_byte(B.VRAM_FLAG,r),t(5),typeof e.read_byte=="function"){const o=e.read_byte(B.MAP_EVENTS_FLAG);e.write_byte(B.MAP_EVENTS_FLAG,o|1),t(5)}}else{console.log("Direct memory manipulation not available, falling back to input simulation");for(let r=0;r<3;r++)e.on_key_down(n.START),t(2),e.on_key_up(n.START),t(10),e.on_key_down(n.B),t(2),e.on_key_up(n.B),t(5)}}catch(r){console.warn("Memory manipulation approach failed:",r)}}function je(e,t){if(!e)return!1;try{console.log("Applying specialized black screen fix after load...");const n={UP:3,DOWN:0,LEFT:1,RIGHT:2,A:4,B:5,START:6,SELECT:7};if(typeof e.write_byte=="function"&&typeof e.read_byte=="function")try{const r=e.read_byte(B.VRAM_FLAG);e.write_byte(B.VRAM_FLAG,r&127),t(5),e.write_byte(B.VRAM_FLAG,r),t(10),console.log("Applied LCD control toggle to force VRAM refresh")}catch(r){console.warn("LCD control manipulation failed:",r)}for(let r=1;r<=5;r++){console.log(`Black screen fix attempt ${r}/5`);const o=Math.min(r,3);if(e.on_key_down(n.START),t(8*o),e.on_key_up(n.START),t(30*o),r>=3&&(e.on_key_down(n.DOWN),t(5*o),e.on_key_up(n.DOWN),t(10*o),e.on_key_down(n.UP),t(5*o),e.on_key_up(n.UP),t(10*o)),e.on_key_down(n.A),t(8*o),e.on_key_up(n.A),t(40*o),e.on_key_down(n.B),t(8*o),e.on_key_up(n.B),t(25*o),e.on_key_down(n.B),t(8*o),e.on_key_up(n.B),t(25*o),r>=3)for(const s of[n.UP,n.RIGHT,n.DOWN,n.LEFT])e.on_key_down(s),t(10*o),e.on_key_up(s),t(10*o);t(20*o)}return t(60),console.log("Black screen fix sequence completed"),!0}catch(n){return console.error("Error in black screen fix:",n),!1}}function St(e){if(!e)return!1;try{if(console.log("Applying direct memory manipulation fix for Pokemon map..."),typeof e.write_byte!="function"||typeof e.read_byte!="function")return console.warn("Direct memory access not supported in this emulator"),!1;const t=e.read_byte(B.TILEMAP_UPDATE);e.write_byte(B.TILEMAP_UPDATE,t+1);for(let s=0;s<10;s++)e.run_frame();e.write_byte(B.TILEMAP_UPDATE,t);const n=e.read_byte(B.SCY_REGISTER);e.write_byte(B.SCY_REGISTER,n+1);for(let s=0;s<10;s++)e.run_frame();e.write_byte(B.SCY_REGISTER,n);const r=e.read_byte(B.MAP_EVENTS_FLAG);e.write_byte(B.MAP_EVENTS_FLAG,r|1);const o=e.read_byte(B.VRAM_FLAG);e.write_byte(B.VRAM_FLAG,o&127);for(let s=0;s<5;s++)e.run_frame();e.write_byte(B.VRAM_FLAG,o);for(let s=0;s<30;s++)e.run_frame();return console.log("Memory-based map fix complete"),!0}catch(t){return console.error("Error in memory-based Pokemon map fix:",t),!1}}function ze(e,t){if(!e)return!1;try{console.log("Applying comprehensive Pokemon map rendering fix...");try{St(e)}catch(n){console.warn("Memory fix step failed:",n)}for(let n=0;n<30;n++)e.run_frame(),n%10===0&&t(0);try{je(e,t)}catch(n){console.warn("Black screen fix step failed:",n)}Fe(e,t);for(let n=0;n<90;n++)e.run_frame(),n%15===0&&t(0);return console.log("Comprehensive map fix complete"),!0}catch(n){return console.error("Error in comprehensive Pokemon map fix:",n),!1}}window.pokemonMapFix={applyComprehensiveFix:ze,fixBlackScreenAfterLoad:je,forceMapRedraw:Fe};const Vo=Object.freeze(Object.defineProperty({__proto__:null,applyComprehensiveFix:ze,applyMemoryFix:St,fixBlackScreenAfterLoad:je,forceMapRedraw:Fe},Symbol.toStringTag,{value:"Module"})),z=io();function Wo(){const e=p.useRef(null),t=p.useRef(null),n=p.useRef(null),[r,o]=p.useState(!0),[s,c]=p.useState(null),[a,i]=p.useState(!0),[u,f]=p.useState(()=>it()),[d]=p.useState(2),[v,S]=p.useState(!1),[b,A]=p.useState(null),[P,T]=p.useState(null),[R,x]=p.useState("idle"),[k,y]=p.useState("idle"),[j,_]=p.useState({status:"initial",message:"Initializing game..."}),[G,L]=p.useState(!1),[N,Y]=p.useState(0),[C,W]=p.useState(""),[We,pe]=p.useState(!1),Oe=p.useRef(0),ee=p.useRef(null),[At,ve]=p.useState(0),ge=p.useRef(null),Se=h=>{Oe.current=h,ee.current&&cancelAnimationFrame(ee.current);const g=()=>{const m=N,M=Oe.current,w=M-m;if(Math.abs(w)<.5){Y(M),ee.current=null;return}const I=m+w*.1;Y(Math.round(I*10)/10),ee.current=requestAnimationFrame(g)};ee.current=requestAnimationFrame(g)},[Ne,re]=p.useState(!1),[Ae,he]=p.useState(!1),[Oo,kt]=p.useState(!1),[Tt,Ue]=p.useState(!1),[Ge,_t]=p.useState(!1),[Et,Ve]=p.useState(!1),[ke,Mt]=p.useState(!1),Ct=p.useRef(null);p.useEffect(()=>{typeof window<"u"&&Z(async()=>{const{getMemoryOptimizer:h}=await Promise.resolve().then(()=>po);return{getMemoryOptimizer:h}},void 0).then(({getMemoryOptimizer:h})=>{Ct.current=h(),console.log("Memory optimizer initialized")}).catch(h=>{console.warn("Failed to load memory optimizer:",h)})},[]),p.useEffect(()=>{/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!ke&&z.state!=="running"&&setTimeout(()=>{Ve(!0)},2e3)},[z.state,ke]);const It=$t(),He=new URLSearchParams(It.search).get("rom")||"pokemon_blue",{gameName:se,gameTitle:Bt,romUrl:Rt}=fo(He),{isAuthenticated:ie,user:$}=ft(),[$e,Lt]=p.useState(null),[Te,Pt]=p.useState(!1),[me,Dt]=p.useState(null),[ae,Ft]=p.useState(null),jt=(h,g,m)=>{console.log("WASM loaded, setting up emulator..."),t.current=h,n.current=g,Dt(h),Ft(g),Pt(!0)};p.useEffect(()=>{me&&(me.JsKeys,Lt({DOWN:0,LEFT:1,RIGHT:2,UP:3,A:4,B:5,START:6,SELECT:7}))},[me]);const{emulatorRef:E,audioSystemRef:te,renderGameFrame:qe}=ho({wasmModule:me,memory:ae||new WebAssembly.Memory({initial:1}),romUrl:Rt||"",canvasRef:e,audioContext:z,onAudioBufferCallback:h=>{if(!(!te?.current||!te.current.scheduleBuffer||!a||!ae))try{z.state!=="running"&&z.resume().catch(()=>{});const g=rt(h,ae,z);if(g)try{te.current.scheduleBuffer(g)}catch(m){console.warn("Failed to schedule audio buffer:",m)}}catch(g){console.warn("Error in audio callback:",g)}},scale:d,onEmulatorReady:h=>{if(console.log("Emulator ready, setting up game state"),console.log("Canvas ref during emulator ready:",!!e.current),e.current){const g=e.current;console.log("Canvas ready with dimensions:",g.width,"x",g.height);const m=g.getContext("2d");if(m){console.log("Canvas context available:",!!m),console.log("Canvas context size:",m.canvas.width,"x",m.canvas.height),m.imageSmoothingEnabled=!1,m.webkitImageSmoothingEnabled!==void 0&&(m.webkitImageSmoothingEnabled=!1),m.mozImageSmoothingEnabled!==void 0&&(m.mozImageSmoothingEnabled=!1),m.msImageSmoothingEnabled!==void 0&&(m.msImageSmoothingEnabled=!1),g.style.display="block",g.style.visibility="visible",g.style.opacity="1",console.log("Testing manual frame render...");const M=qe(!1);console.log("Manual render result:",M),m.fillStyle="#ff0000",m.fillRect(0,0,50,50),m.fillStyle="#00ff00",m.fillRect(50,0,50,50),m.fillStyle="#0000ff",m.fillRect(0,50,50,50),m.fillStyle="#ffff00",m.fillRect(50,50,50,50),console.log("🎨 Drew test pattern to canvas"),console.log("Canvas ready for useGameLoop to take over when isLoading becomes false"),window.memory?console.log("WebAssembly memory available:",window.memory.buffer.byteLength,"bytes"):console.error("WebAssembly memory not accessible!");try{if(h.get_canvas_data_pointer){const w=h.get_canvas_data_pointer();console.log("Canvas data pointer:",w)}else console.error("get_canvas_data_pointer method not available!")}catch(w){console.error("Error getting canvas data pointer:",w)}}else console.error("Canvas context not available!")}console.log("🎮 About to set isLoading(false) - this should trigger useGameLoop"),o(!1),console.log("🎮 isLoading set to false - useGameLoop should start now"),setTimeout(()=>{if(e.current){const g=e.current,m=g.getBoundingClientRect();console.log("📺 Canvas visibility check:",{display:g.style.display,position:g.style.position,top:g.style.top,left:g.style.left,visible:g.offsetParent!==null,width:g.width,height:g.height,clientWidth:g.clientWidth,clientHeight:g.clientHeight,boundingRect:{x:m.x,y:m.y,width:m.width,height:m.height,inViewport:m.x>=0&&m.y>=0&&m.x<window.innerWidth&&m.y<window.innerHeight},computedStyle:{display:getComputedStyle(g).display,visibility:getComputedStyle(g).visibility,opacity:getComputedStyle(g).opacity,zIndex:getComputedStyle(g).zIndex}})}},100),kt(!0),j.status==="initial"&&_({status:"ready",message:"Game initialized!"})},onError:c,setIsLoading:o,setMapFixesApplied:pe,setConfirmationModalDismissed:he}),_e=p.useRef([]),{renderGameFrame:Ee,pauseGameLoop:zt,resumeGameLoop:Wt}=mo({emulatorRef:E,canvasRef:e,audioContext:z,scale:d,soundEnabled:a,setSoundEnabled:i,isLoading:r,inputQueueRef:_e}),Je=async()=>{if(!E.current||!ie||!$)return console.log("Cannot save: emulator not ready, not authenticated, or no user"),!1;x("saving");try{console.log("Starting Pokemon-enhanced save process...");for(let w=0;w<5;w++)E.current.run_frame();const h=e.current;if(h){const w=h.getContext("2d");w&&(w.fillStyle="rgba(255, 255, 255, 0.4)",w.fillRect(0,0,w.canvas.width,w.canvas.height),Ee(!1),await new Promise(I=>setTimeout(I,100)))}let g=E.current.save_state();if(!g||g.length===0)throw new Error("No save state data received from emulator");console.log(`Got save state data: ${g.length} bytes`);try{const{manuallyExtractCartridgeRam:w}=await Z(async()=>{const{manuallyExtractCartridgeRam:q}=await import("./cartridgeRamDebugger-DtBOoSTV.js");return{manuallyExtractCartridgeRam:q}},[]),I=w(E.current);if(I){const{extractCartridgeRamFromSaveState:q,replaceCartridgeRamInSaveState:ce}=await Z(async()=>{const{extractCartridgeRamFromSaveState:V,replaceCartridgeRamInSaveState:Ie}=await import("./cartridgeRamExtractor-CGD_AEfh.js");return{extractCartridgeRamFromSaveState:V,replaceCartridgeRamInSaveState:Ie}},[]),ye=q(g),be=I?Array.from(I).filter(V=>V!==255&&V!==0).length:0;(ye?Array.from(ye).filter(V=>V!==255&&V!==0).length:0)===0&&be>0&&(console.log("Enhancing save state with cartridge RAM data"),g=ce(g,I))}}catch(w){console.warn("SAVE DEBUG: Error during cartridge RAM verification:",w)}try{const{validatePokemonSaveState:w}=await Z(async()=>{const{validatePokemonSaveState:q}=await import("./index-BBtjCGTq.js").then(ce=>ce.o);return{validatePokemonSaveState:q}},__vite__mapDeps([3,4])),I=w(g,!0);console.log("Save state metadata:",I.metadata)}catch(w){console.warn("Save state validation not available:",w)}const m=g instanceof Uint8Array?g:new Uint8Array(g);if((await qt($.fid,m,se)).success){if(S(!0),A(m),T(new Date),x("success"),h){const w=h.getContext("2d");w&&(w.fillStyle="rgba(0, 255, 0, 0.3)",w.fillRect(0,0,h.width,h.height))}for(let w=0;w<5;w++)E.current.run_frame();return Ee(!1),setTimeout(()=>x("idle"),2e3),!0}else throw new Error("Failed to save game state to database")}catch(h){return console.error("Error saving game state:",h),x("error"),setTimeout(()=>x("idle"),2e3),!1}},Xe=He!=="pokemon_yellow",{getDebugInfo:Me,resetDetection:Ze}=Ro({isGameReady:Xe&&j.status==="ready",emulator:E.current,mapFixesApplied:We,confirmationModalDismissed:Ae,onSaveAfterDetection:Je,disabled:!Xe});p.useEffect(()=>{typeof window<"u"&&(window.starterDebug={getInfo:Me,reset:Ze,log:()=>console.log("🔧 Starter Detection Debug Info:",Me())})},[Me,Ze]);const Ce=async h=>{if(!E.current||!e.current)return!1;console.log("🛑 Pausing game loop for save state loading..."),zt();try{try{const{validatePokemonSaveState:M}=await Z(async()=>{const{validatePokemonSaveState:I}=await import("./index-BBtjCGTq.js").then(q=>q.o);return{validatePokemonSaveState:I}},__vite__mapDeps([3,4])),w=M(h,!0);console.log("Save state validation:",w),!w.isValid&&w.issues.length>0&&console.warn("Save state validation issues:",w.issues)}catch(M){console.warn("Save state validation not available:",M)}const{applySaveStateWithOptimizations:g}=await Z(async()=>{const{applySaveStateWithOptimizations:M}=await import("./SaveStateHelpers-DHZewPwJ.js");return{applySaveStateWithOptimizations:M}},__vite__mapDeps([5,3,4]));return await g({emulator:E.current,canvas:e.current,saveData:h,wasmModule:t.current,renderGameFrame:Ee,setShowMapFixLoader:L,setMapFixProgress:Se,setMapFixDetailedStatus:W,setMapFixesApplied:pe,setShowConfirmationModal:re,setConfirmationModalDismissed:he})}finally{console.log("✅ Save state loading finished, resuming game loop..."),Wt()}};p.useEffect(()=>{async function h(){if(!ie||!$){console.log("Not authenticated or no user, skipping save check");return}if(!E.current||!Te){console.log("Emulator not ready yet, waiting...",{emulator:!!E.current,wasmLoaded:Te});return}console.log("Checking for saved game state...",{fid:$.fid,game:se});try{_({status:"checking_saves",message:"Checking for saved game..."});const g=await tt($.fid,se);console.log("Save state check result:",g),g&&g.gameData?(console.log("Found save state, will load it"),A(g.gameData),S(!0),g.lastSaved&&T(new Date(g.lastSaved)),y("loading"),_({status:"loading_save",message:"Save state found! Loading..."}),setTimeout(async()=>{await Ce(g.gameData)?setTimeout(()=>{y("success"),_({status:"ready",message:"Save state loaded successfully!"})},1e3):(y("error"),_({status:"ready",message:"Starting new game..."}))},500)):(console.log("No save state found, starting new game"),_({status:"starting_new",message:"Starting new game..."}),setTimeout(()=>{_({status:"ready",message:"New game started!"})},1e3))}catch(g){console.warn("Error checking for saved game:",g),_({status:"starting_new",message:"Starting new game..."}),setTimeout(()=>{_({status:"ready",message:"New game started!"})},1e3)}}h()},[ie,$,se,E.current,Te]),p.useEffect(()=>{b&&E.current&&j.status==="loading_save"&&Ce(b).then(h=>{h?_({status:"ready",message:"Save state loaded successfully!"}):(console.warn("Failed to apply save state"),_({status:"ready",message:"Starting new game..."}))})},[b,E.current,j.status]);const Ot=async()=>{if(!E.current||!ie||!$||!v||!b)return console.log("Cannot load: emulator not ready, not authenticated, no user, or no save state"),!1;y("loading"),setTimeout(()=>y("idle"),2e3);try{const h=e.current;if(h){const m=h.getContext("2d");m&&(m.fillStyle="rgba(0, 0, 255, 0.3)",m.fillRect(0,0,h.width,h.height))}y("success"),console.log("Loading save state...");const g=await tt($.fid,se);return g&&g.gameData?(A(g.gameData),S(!0),g.lastSaved&&T(new Date(g.lastSaved)),y("success"),setTimeout(()=>y("idle"),2e3),console.log("Save state loaded from database, applying..."),await Ce(g.gameData)?(y("success"),setTimeout(()=>y("idle"),2e3),!0):(y("error"),setTimeout(()=>y("idle"),2e3),!1)):(y("error"),setTimeout(()=>y("idle"),2e3),!1)}catch(h){return console.error("Error loading game state:",h),y("error"),setTimeout(()=>y("idle"),2e3),!1}},Nt=()=>{if(!(!E.current||!e.current))try{console.log("Starting comprehensive Pokemon map fix..."),re(!1),he(!1),L(!0),Se(0),W(`Initializing map fixes...
Analyzing current game state...`);const h=(m,M,w,I)=>new Promise(q=>{const ce=Date.now(),ye=M-m,be=()=>{const Ye=Date.now()-ce,V=Math.min(Ye/w,1),Ie=m+ye*V;Se(Math.round(Ie)),W(I),V<1?requestAnimationFrame(be):q()};be()});setTimeout(async()=>{try{await h(0,25,1500,`Preparing emulator for fixes...
Checking memory state...`);const m=(w=10)=>{for(let I=0;I<w;I++)E.current.run_frame()};if(await h(25,50,1e3,`Applying basic memory fixes...
Refreshing map data...`),ze(E.current,m)){await h(50,65,800,`Basic fixes applied...
Loading enhanced fixes...`);try{const{applyAllMapFixes:w}=await Z(async()=>{const{applyAllMapFixes:I}=await import("./enhancedPokemonMapFix-BKxRcP10.js");return{applyAllMapFixes:I}},[]);await h(65,85,1200,`Applying enhanced map fixes...
Optimizing display rendering...`),w(E.current,m,()=>{}),pe(!0),await h(85,100,800,`Map fixes complete!
Rendering optimized display...`),qe(!1),setTimeout(()=>{L(!1),setTimeout(()=>{re(!0)},300)},500)}catch(w){console.warn("Enhanced fixes not available:",w),await h(65,100,1e3,`Basic fixes complete!
Map display ready...`),pe(!0),setTimeout(()=>{L(!1),setTimeout(()=>{re(!0)},300)},500)}}else console.warn("Basic map fix failed"),L(!1)}catch(m){console.error("Error applying map fix:",m),L(!1)}},300)}catch(h){console.error("Error in map rendering fix:",h),L(!1)}};p.useEffect(()=>{if(!t.current)return;const h=t.current;function g(M){if(!E.current)return;const w={ArrowUp:h.JsKeys.ArrowUp,ArrowDown:h.JsKeys.ArrowDown,ArrowLeft:h.JsKeys.ArrowLeft,ArrowRight:h.JsKeys.ArrowRight,z:h.JsKeys.A,x:h.JsKeys.B,Enter:h.JsKeys.Start," ":h.JsKeys.Select};if(w[M.key]!==void 0&&E.current)try{E.current.on_key_down(w[M.key]),M.preventDefault()}catch(I){console.error(`Error in on_key_down for key ${M.key}:`,I)}}function m(M){if(!E.current)return;const w={ArrowUp:h.JsKeys.ArrowUp,ArrowDown:h.JsKeys.ArrowDown,ArrowLeft:h.JsKeys.ArrowLeft,ArrowRight:h.JsKeys.ArrowRight,z:h.JsKeys.A,x:h.JsKeys.B,Enter:h.JsKeys.Start," ":h.JsKeys.Select};if(w[M.key]!==void 0&&E.current)try{E.current.on_key_up(w[M.key]),M.preventDefault()}catch(I){console.error(`Error in on_key_up for key ${M.key}:`,I)}}return window.addEventListener("keydown",g),window.addEventListener("keyup",m),()=>{window.removeEventListener("keydown",g),window.removeEventListener("keyup",m)}},[t.current]);const[Ut,Qe]=p.useState(!0);p.useEffect(()=>{if(r){Qe(!0),ve(0);const h=Date.now(),g=()=>{const m=Date.now()-h,M=Math.min(95,m/30*Math.log(m+100));ve(M),r&&M<95&&(ge.current=requestAnimationFrame(g))};ge.current=requestAnimationFrame(g)}else ve(100),setTimeout(()=>{Qe(!1)},300)},[r]),p.useEffect(()=>()=>{ee.current&&cancelAnimationFrame(ee.current),ge.current&&cancelAnimationFrame(ge.current)},[]);const Ke=l.jsx(Jt,{onWasmLoaded:jt,onError:c});return s?l.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"red"},children:[Ke,l.jsx("h2",{children:"Error Loading Game"}),l.jsx("p",{children:s}),l.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"10px 20px",fontSize:"16px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"5px",cursor:"pointer"},children:"Reload Page"})]}):l.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"#000",position:"relative",overflow:"hidden"},children:[l.jsx("div",{style:{flex:1,display:"flex",justifyContent:"center",alignItems:"center",position:"relative",padding:"10px",paddingBottom:u?"180px":"10px",maxHeight:u?"calc(100vh - 200px)":"100vh"},children:l.jsx("canvas",{ref:e,width:320,height:288,style:{display:r?"none":"block",position:r?"absolute":"static",top:r?"-9999px":"auto",left:r?"-9999px":"auto",width:"100%",height:"100%",imageRendering:"pixelated",WebkitImageRendering:"-webkit-optimize-contrast",WebkitFontSmoothing:"none",backgroundColor:"#9bbc0f",border:r?"none":"2px solid #333",maxWidth:"100%",maxHeight:"100%",objectFit:"contain",zIndex:r?-1:1}})}),Ke,l.jsx(at,{visible:Ut,progress:Math.round(At),message:`Loading ${Bt}...`,detailedStatus:j.message}),k==="loading"&&l.jsx("div",{style:{position:"absolute",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"rgba(0, 0, 0, 0.8)",color:"#fff",padding:"10px 20px",borderRadius:"8px",zIndex:50,fontSize:"14px",border:"1px solid #333"},children:"Loading Save State..."}),l.jsx(uo,{emulatorRef:E,wasmModuleRef:t,audioSystemRef:te,audioContext:z,soundEnabled:a,setSoundEnabled:i,onAudioBufferCallback:h=>{if(!te?.current||!te.current.scheduleBuffer||!a||!ae)return;const g=rt(h,ae,z);if(g)try{te.current.scheduleBuffer(g)}catch(m){console.warn("AudioManager callback error:",m)}}}),l.jsx("div",{style:{flex:1,display:"flex",justifyContent:"center",alignItems:"center",position:"relative",padding:"10px"},children:l.jsxs("div",{style:{position:"relative",maxWidth:"100%",maxHeight:"100%",aspectRatio:"160/144"},children:[l.jsx("div",{style:{position:"absolute",top:"6px",right:"6px",width:"20px",height:"20px",backgroundColor:a?"#4CAF50":"#f44336",borderRadius:"50%",zIndex:20,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",color:"white",fontWeight:"bold"},children:a?"🔊":"🔇"}),it()&&l.jsx("div",{style:{position:"absolute",top:"6px",left:"6px",zIndex:20},children:l.jsx("button",{onClick:()=>f(!u),style:{width:"40px",height:"40px",borderRadius:"20px",backgroundColor:u?"#4CAF50":"#757575",border:"none",color:"white",fontSize:"16px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:"🎮"})})]})}),l.jsx(xo,{title:"Game Menu",children:l.jsxs("div",{style:{padding:"20px"},children:[l.jsx("button",{onClick:()=>window.location.href="/",style:{width:"100%",margin:"5px 0",padding:"10px",backgroundColor:"#3a539b",color:"white",border:"none",borderRadius:"4px",fontSize:"14px",fontWeight:"bold"},children:"🎮 Back to Games"}),l.jsx("button",{onClick:Nt,style:{width:"100%",margin:"5px 0",padding:"10px",backgroundColor:"#17a2b8",color:"white",border:"none",borderRadius:"4px",fontSize:"14px",fontWeight:"bold"},children:"🔧 Fix Map Display"})]})}),G&&l.jsx(at,{visible:G,progress:N,detailedStatus:C}),Ne&&!Ae&&l.jsx(vo,{visible:Ne&&!Ae,title:"Map Fix Complete",message:"Pokemon map rendering has been optimized. Your game should now display correctly. You can continue playing!",onConfirm:()=>{re(!1),he(!0),Ge||setTimeout(()=>{Ue(!0)},500)},confirmText:"Continue Playing"}),l.jsx(wo,{emulatorRef:E,showBattleWarning:Tt,setShowBattleWarning:Ue,battleWarningShown:Ge,setBattleWarningShown:_t}),Et&&!ke&&l.jsxs("div",{style:{position:"fixed",top:"60px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#ff9800",color:"white",padding:"10px 20px",borderRadius:"20px",zIndex:100,maxWidth:"90%",textAlign:"center",fontSize:"14px",boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},children:[l.jsx("div",{style:{marginBottom:"8px"},children:"🔊 Tap here to enable audio on iOS"}),l.jsx("button",{onClick:()=>{if(K(),/iPhone|iPad|iPod/i.test(navigator.userAgent))try{const g=z.createOscillator(),m=z.createGain();m.gain.value=.2,g.connect(m),m.connect(z.destination),g.start(0),g.stop(z.currentTime+.2),z&&typeof z.resume=="function"&&z.resume()}catch(g){console.log("iOS audio unlock attempt:",g)}Ve(!1),Mt(!0)},style:{backgroundColor:"rgba(255,255,255,0.2)",border:"1px solid rgba(255,255,255,0.5)",color:"white",padding:"8px 16px",borderRadius:"15px",cursor:"pointer",fontSize:"12px",animation:"pulse 2s infinite"},children:"Enable Audio"}),l.jsx("style",{children:`
            @keyframes pulse {
              0% { transform: scale(1); opacity: 1; }
              50% { transform: scale(1.05); opacity: 0.8; }
              100% { transform: scale(1); opacity: 1; }
            }
          `})]}),ie&&$&&l.jsx("div",{style:{position:"absolute",top:"10px",left:"10px",zIndex:30},children:l.jsx(bo,{onSave:Je,onLoad:Ot,savingState:R,loadingState:k,hasSaveState:v,lastSaved:P})}),u&&$e&&l.jsx(yo,{visible:!0,keyCodes:$e,onKeyDown:h=>{_e.current.push({type:"down",keyCode:h})},onKeyUp:h=>{_e.current.push({type:"up",keyCode:h})}})]})}const Ho=Object.freeze(Object.defineProperty({__proto__:null,default:Wo},Symbol.toStringTag,{value:"Module"}));export{Wo as S,Ho as a,Vo as p};
